<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Spring | Funkynoob的个人博客</title><meta name="author" content="JiangHaiYang aka Funkynoob"><meta name="copyright" content="JiangHaiYang aka Funkynoob"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="引入考虑下面一个模拟保存用户的MVC程序： 12345678910111213141516171819202122232425262728293031323334&#x2F;&#x2F;dao层public interface IUserDao &#123;    void saveUser();&#125;public class UserDaoForMysqlImpl implements IUserDao &amp;#">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring">
<meta property="og:url" content="https://funkynoob.gitee.io/2024/02/21/spring/index.html">
<meta property="og:site_name" content="Funkynoob的个人博客">
<meta property="og:description" content="引入考虑下面一个模拟保存用户的MVC程序： 12345678910111213141516171819202122232425262728293031323334&#x2F;&#x2F;dao层public interface IUserDao &#123;    void saveUser();&#125;public class UserDaoForMysqlImpl implements IUserDao &amp;#">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://funkynoob.gitee.io/images/funkynoob_avatar.jpg">
<meta property="article:published_time" content="2024-02-21T05:47:16.000Z">
<meta property="article:modified_time" content="2024-03-06T09:22:01.943Z">
<meta property="article:author" content="JiangHaiYang aka Funkynoob">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://funkynoob.gitee.io/images/funkynoob_avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://funkynoob.gitee.io/2024/02/21/spring/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-06 17:22:01'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/funkynoob_avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-play"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐(待更新)</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影(待更新)</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa-regular fa-images"></i><span> 画廊(持续更新)</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fa-solid fa-gamepad"></i><span> 游戏(待更新)</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> Spring框架</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/spring/"><span> Spring</span></a></li><li><a class="site-page child" href="/springmvc/"><span> SpringMVC</span></a></li><li><a class="site-page child" href="/springcloud/"><span> SpringCloud</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> Web服务器</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/2024/01/23/nginx"><span> Nginx</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> ORM框架</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/2024/01/28/mybatis"><span> Mybatis</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/preview.gif')"><nav id="nav"><span id="blog-info"><a href="/" title="Funkynoob的个人博客"><span class="site-name">Funkynoob的个人博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-play"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐(待更新)</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影(待更新)</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa-regular fa-images"></i><span> 画廊(持续更新)</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fa-solid fa-gamepad"></i><span> 游戏(待更新)</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> Spring框架</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/spring/"><span> Spring</span></a></li><li><a class="site-page child" href="/springmvc/"><span> SpringMVC</span></a></li><li><a class="site-page child" href="/springcloud/"><span> SpringCloud</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> Web服务器</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/2024/01/23/nginx"><span> Nginx</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><span> ORM框架</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/2024/01/28/mybatis"><span> Mybatis</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-21T05:47:16.000Z" title="发表于 2024-02-21 13:47:16">2024-02-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-06T09:22:01.943Z" title="更新于 2024-03-06 17:22:01">2024-03-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/spring/">spring</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">26.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>105分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h1><p>考虑下面一个模拟保存用户的<code>MVC</code>程序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dao层</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoForMysqlImpl</span> <span class="keyword">implements</span> <span class="title class_">IUserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;正在保存user for mysql&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//service层</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">IUserDao</span> <span class="variable">userDao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDaoForMysqlImpl</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">()</span> &#123;</span><br><span class="line">        userDao.saveUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//controller层</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Controller</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">IUserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        userService.saveUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">正在保存user for mysql</span><br></pre></td></tr></table></figure>

<p>运行结果看起来完美无缺，能够正常保存，于是你正常上线。但某一天客户突然要求你更换数据库为 <code>Oracle</code> 而不是 <code>Mysql</code>，你可能会想那好办，我再写一个 <code>UserDaoForOracleImpl</code> 就好了呗。于是你马不停蹄地写出了这个给类，然后一一更改每一层的依赖…..</p>
<p>这样的操作以及源代码有什么问题？</p>
<p>由<strong>OCP原则</strong>可知：当应用的需求改变时，在不修改软件实体的源代码或者二进制代码的前提下，我们应当采用扩展。对源代码的修改显然已经破坏了这个原则。</p>
<p>由<strong>DIP原则</strong>可知：高层模块不应该依赖于下层模块的细节，也就是不应该在程序中出现下层模块的实例，换句话说也就是面向接口开发。源代码中高层对底层的依赖显然也违背了这个原则。</p>
<p>由于高层实例和下层实例的强耦合，导致每做出一次更新，就要修改源代码，也就导致每次更新都要重新对以往的代码进行测试。</p>
<p>争对以上所述情况，出现了一个新型的解决方案：<code>IOC</code></p>
<blockquote>
<p> [!Important]</p>
<p><strong>开闭原则(<font color="red">O</font>pen <font color="red">C</font>lose <font color="red">P</font>rinciple OCP)</strong> ：软件实体应当对扩展开放，对修改关闭。</p>
<p>Software entities should be open for extension，but closed for modification.</p>
<p><strong>依赖倒置原则(<font color="red">D</font>ependency <font color="red">I</font>version <font color="red">P</font>rinciple DIP)</strong> ：高层模块不应该依赖低层模块，两者都应该依赖其抽象；抽象不应该依赖细节，细节应该依赖抽象。</p>
<p>High level modules shouldn’t depend upon low level modules. Both should depend upon abstractions. Abstractions should not depend upon details. Details should depend upon abstractions.</p>
</blockquote>
<h1 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h1><p><strong>控制反转(nversion <font color="red">o</font>f <font color="red">C</font>ontrol IoC)</strong> ：通过使用直接构建类或诸如服务定位模式的机制来控制其依赖关系的实例化或位置的逆过程。以上为<a target="_blank" rel="noopener" href="https://docs.spring.io/Spring-framework/reference/core/beans/introduction.html">Spring官方</a>的解释。</p>
<p>可能不太好懂，可以换作通俗的话来解释。也就是解释反转是什么：</p>
<ol>
<li>不在程序中采用硬编码的方式来 <code>new</code> 对象，也就是说<strong>创造对象的权力</strong>被我反转出去了。</li>
<li>不在程序中自己解决对象之间的依赖问题，也就是说<strong>依赖关系的维护权</strong>被我反转出去了。</li>
</ol>
<p><code>Ioc</code> 是种思想，不是某种具体的解决措施。 <code>Ioc</code> 有很多种实现方式。</p>
<p><code>Spring</code>框架(容器)为我们提供了 <code>Ioc</code> 的一种具体的解决办法也就是<strong>依赖注入(<font color="red">D</font>ependency <font color="red">I</font>njection DI)</strong> 。也就是说我们能通过<strong>依赖注入</strong>来实现<strong>控制反转</strong>。</p>
<p>依赖注入 <code>DI</code> 的两种注入方式：</p>
<ul>
<li>构造器注入：通过构造器注入</li>
<li><code>set</code> 注入：通过 <code>set</code> 方法注入</li>
</ul>
<blockquote>
<p>[!Note]</p>
<p>依赖：A和B之间的关系</p>
<p>注入：创造A和B之间的关系</p>
</blockquote>
<h2 id="第一个Spring程序"><a href="#第一个Spring程序" class="headerlink" title="第一个Spring程序"></a>第一个Spring程序</h2><h3 id="获取配置文件"><a href="#获取配置文件" class="headerlink" title="获取配置文件"></a>获取配置文件</h3><p><code>Spring</code> 框架称呼被 <code>Ioc</code> 管理的对象为 <code>bean</code>。<code>Spring</code> 通过 <code>xml</code> 配置文件来进行相关配置，同时<strong>对配置文件的命名不做要求</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans http://www.Springframework.org/schema/beans/Spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   bean标签为bean对象</span></span><br><span class="line"><span class="comment">   id：代表bean对象的唯一标识，不能重复。否则会抛出BeanDefinitionParsingException bean定义解析错误</span></span><br><span class="line"><span class="comment">   class：实例对象的全类名</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.demo.bens.UserBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取IoC容器"><a href="#获取IoC容器" class="headerlink" title="获取IoC容器"></a>获取IoC容器</h3><p>配置完成配置文件后，紧接着就要通过解析配置文件获取 <code>IOC</code> 容器，在 <code>Spring</code> 中 <code>ApplicationContext</code> 接口即为 <code>IoC</code> 容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在类路径中查找配置文件</span></span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;Spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//在本地查找配置文件</span></span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileSystemXmlApplicationContext</span>(<span class="string">&quot;path/to/xml&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化Ioc容器时支持多个配置文件</span></span><br><span class="line"><span class="comment">//ApplicationContext ioc = new ClassPathXmlApplicationContext(&quot;asd.xml&quot;,&quot;asad.xml&quot;,&quot;asdaa.xml&quot;....);</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在获取 <code>IoC</code> 容器时，就会实例化那些单例的 <code>bean</code></p>
<p><code>ApplicationContext</code> 继承自 <code>BeanFactory</code>，实际上也就是 <code>bean</code>工厂。</p>
</blockquote>
<h3 id="获取bean"><a href="#获取bean" class="headerlink" title="获取bean"></a>获取bean</h3><p>获得 <code>Ioc</code> 容器后，我们就可以获取容器里面锁创造的 <code>bean</code> 了，<code>Spring</code> 提供了三种获取 <code>bean</code> 的重载方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">userBean</span> <span class="operator">=</span> ioc.getBean(<span class="string">&quot;userBean&quot;</span>);</span><br><span class="line"><span class="type">UserBean</span> <span class="variable">userBean</span> <span class="operator">=</span> ioc.getBean(<span class="string">&quot;userBean&quot;</span>,UserBean.class);</span><br><span class="line"><span class="type">UserBean</span> <span class="variable">userBean</span> <span class="operator">=</span> ioc.getBean(UserBean.Class);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Spring</code> 框架通过反射机制和工厂模式来创造 <code>bean</code> 。也就是：首先解析 <code>XML</code> 文件，获取类路径，其次通过工厂模式利用反射通过类路径创建对象。</p>
<p><code>Spring</code> 默认使用空构造方法创建对象。</p>
<p><code>Spring</code> 底层使用一个 <code>map</code> 集合来管理对象和 <code>id</code> 之间的关系，<code>getBean</code> 方法实际上是就是通过键获取值。</p>
<p>当获取 <code>bean</code> 时，如果指定的<code>id</code> 或者类型不存在，那么将会抛出 <code>NoSuchBeanDefinitionException</code> 没有该 <code>bean</code> 定义异常</p>
</blockquote>
<h2 id="Spring对IOC的实现"><a href="#Spring对IOC的实现" class="headerlink" title="Spring对IOC的实现"></a>Spring对IOC的实现</h2><h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><p>解决对象之间的依赖问题。</p>
<h4 id="set注入"><a href="#set注入" class="headerlink" title="set注入"></a>set注入</h4><p><code>set</code> 注入，基于 <code>set</code> 方法实现的，底层会通过反射机制调用属性对应的 <code>set</code> 方法然后给属性赋值。这种方式要求属性必须对外提供 <code>set</code> 方法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans http://www.Springframework.org/schema/beans/Spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.dao.UserDao&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.UserService&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">		property标签：代表通过set的方式注入</span></span><br><span class="line"><span class="comment">		name：代表对应属性。注意，该属性不是指的属性名，而是setter方法，去掉set以及首字母小写之后的属性。</span></span><br><span class="line"><span class="comment">		ref：引用类型。ref填入的时其他bean的id</span></span><br><span class="line"><span class="comment">		value：普通的字面量</span></span><br><span class="line"><span class="comment">		--&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDao&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">value</span>=<span class="string">&quot;world&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>set注入底层通过反射获取的setter方法，所以name属性必须是setter方法去掉set以及首字母小写之后的名字</p>
</blockquote>
<h4 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h4><p>核心原理：通过调用构造方法来给属性赋值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.dao.UserDao&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;customService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.CustomService&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	constructor-arg：代表通过构造器注入</span></span><br><span class="line"><span class="comment">	index：构造器中的参数位置，默认以0开始</span></span><br><span class="line"><span class="comment">	name：参数名字</span></span><br><span class="line"><span class="comment">	type：参数类型</span></span><br><span class="line"><span class="comment">	value和ref与set注入同</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">value</span>=<span class="string">&quot;world&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value</span>=<span class="string">&quot;haha&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>不指定 <code>index</code> 、<code>name</code> 和 <code>type</code> 的话，<code>Spring</code> 也能猜出来该赋值给谁。注意此方法也是使用的 <code>type</code></p>
<p>两种注入方式的实际不同：一个是实例化后注入，一个是实例的时候就注入。</p>
</blockquote>
<h3 id="set注入专题"><a href="#set注入专题" class="headerlink" title="set注入专题"></a>set注入专题</h3><h4 id="注入外部Bean"><a href="#注入外部Bean" class="headerlink" title="注入外部Bean"></a>注入外部Bean</h4><p>引用的是在 <code>bean</code> 外面定义的 <code>bean</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.OrderSerivce&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;orderDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;orderDaoBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入内部bean"><a href="#注入内部bean" class="headerlink" title="注入内部bean"></a>注入内部bean</h4><p>在 <code>bean</code> 标签中嵌套 <code>bean</code> 标签。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderServiceInner&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.OrderSerivce&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;orderDao&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入简单类型"><a href="#注入简单类型" class="headerlink" title="注入简单类型"></a>注入简单类型</h4><p><code>Spring</code> 认为的简单类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSimpleValueType</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (!isVoidType(type) &amp;&amp;</span><br><span class="line">            (isPrimitiveOrWrapper(type) || <span class="comment">//基本类型和包装类型</span></span><br><span class="line">             Enum.class.isAssignableFrom(type) || <span class="comment">//枚举类型</span></span><br><span class="line">             CharSequence.class.isAssignableFrom(type) || </span><br><span class="line">             Number.class.isAssignableFrom(type) ||</span><br><span class="line">             Date.class.isAssignableFrom(type) || <span class="comment">//日期</span></span><br><span class="line">             Temporal.class.isAssignableFrom(type) || </span><br><span class="line">             ZoneId.class.isAssignableFrom(type) ||</span><br><span class="line">             TimeZone.class.isAssignableFrom(type) ||</span><br><span class="line">             File.class.isAssignableFrom(type) ||</span><br><span class="line">             Path.class.isAssignableFrom(type) ||</span><br><span class="line">             Charset.class.isAssignableFrom(type) ||</span><br><span class="line">             Currency.class.isAssignableFrom(type) ||</span><br><span class="line">             InetAddress.class.isAssignableFrom(type) ||</span><br><span class="line">             URI.class == type ||</span><br><span class="line">             URL.class == type ||</span><br><span class="line">             UUID.class == type ||</span><br><span class="line">             Locale.class == type ||</span><br><span class="line">             Pattern.class == type ||</span><br><span class="line">             Class.class == type));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注入简单类型形如如下形式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderServiceInner&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.OrderSerivce&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">value</span>=<span class="string">&quot;world&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当把日期当作简单类型注入时必须考虑注入的格式，要必须完全符合日期格式才能成功注入，如下所示</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.OrderSerivce&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;date&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Thu Feb 22 10:53:41 CST 2024&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;date1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2024/2/22 20:20:20&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="级联属性赋值"><a href="#级联属性赋值" class="headerlink" title="级联属性赋值"></a>级联属性赋值</h4><p>引用外部 <code>bean</code> 后，对外部 <code>bean</code> 的属性赋值</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;class&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Clazz&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jjj&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;clazz&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;class&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;clazz.name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;软件1班&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入数组"><a href="#注入数组" class="headerlink" title="注入数组"></a>注入数组</h4><p>在注入时使用标签：<code>&lt;array&gt;</code></p>
<h5 id="简单类型"><a href="#简单类型" class="headerlink" title="简单类型"></a>简单类型</h5><p>在 <code>&lt;array&gt;</code> 中使用 <code>&lt;value&gt;</code> 标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jjj&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;clazz&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>456<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h5><p>在 <code>&lt;array&gt;</code> 中使用 <code>&lt;ref&gt;</code> 标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dept1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Dept&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dept2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Dept&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dept3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Dept&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;employee&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Employee&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;depts&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;dept1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;dept2&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;dept3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入list集合"><a href="#注入list集合" class="headerlink" title="注入list集合"></a>注入list集合</h4><p>在注入时使用标签：<code>&lt;list&gt;</code></p>
<h5 id="是简单类型"><a href="#是简单类型" class="headerlink" title="是简单类型"></a>是简单类型</h5><p>在 <code>&lt;list&gt;</code> 中使用 <code>&lt;value&gt;</code> 标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jjj&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;clazz&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>456<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="引用类型-1"><a href="#引用类型-1" class="headerlink" title="引用类型"></a>引用类型</h5><p>在 <code>&lt;list&gt;</code> 中使用 <code>&lt;ref&gt;</code> 标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dept1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Dept&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dept2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Dept&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dept3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Dept&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;employee&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Employee&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;depts&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;dept1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;dept2&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;dept3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入map集合"><a href="#注入map集合" class="headerlink" title="注入map集合"></a>注入map集合</h4><p>在注入时使用标签：<code>&lt;map&gt;</code> 以及其中的 <code>&lt;entry&gt;</code></p>
<h5 id="简单类型-1"><a href="#简单类型-1" class="headerlink" title="简单类型"></a>简单类型</h5><p>在 <code>&lt;entry&gt;</code> 中使用 <code>&lt;value&gt;</code> 或者 <code>&lt;key&gt;</code> 标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;peopleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;addrs&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--如果key不是简单类型，使用 key-ref 属性--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--如果value不是简单类型，使用 value-ref 属性--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;北京大兴区&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;上海浦东区&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;3&quot;</span> <span class="attr">value</span>=<span class="string">&quot;深圳宝安区&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="引用类型-2"><a href="#引用类型-2" class="headerlink" title="引用类型"></a>引用类型</h5><p>在 <code>&lt;entry&gt;</code> 中使用 <code>&lt;value-ref&gt;</code> 或者 <code>&lt;key-ref&gt;</code> 标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;emploee1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Employee&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;deptMap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--如果key不是简单类型，使用 key-ref 属性--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--如果value是简单类型，使用 value 属性--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;1&quot;</span> <span class="attr">key-ref</span>=<span class="string">&quot;dept1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;2&quot;</span> <span class="attr">key-ref</span>=<span class="string">&quot;dept2&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;3&quot;</span> <span class="attr">key-ref</span>=<span class="string">&quot;dept3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入set集合"><a href="#注入set集合" class="headerlink" title="注入set集合"></a>注入set集合</h4><p>在注入时使用 <code>&lt;set&gt;</code> 标签</p>
<h5 id="简单类型-2"><a href="#简单类型-2" class="headerlink" title="简单类型"></a>简单类型</h5><p>在 <code>&lt;set&gt;</code> 中使用 <code>&lt;value&gt;</code> 标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;peopleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;phones&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--简单类型使用value，非简单类型可以使用ref--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>110<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>110<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>120<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>120<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>119<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>119<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="引用类型-3"><a href="#引用类型-3" class="headerlink" title="引用类型"></a>引用类型</h5><p>在 <code>&lt;set&gt;</code> 中使用 <code>&lt;ref&gt;</code> 标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;peopleBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.People&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;phones&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--非简单类型可以使用ref，简单类型使用value--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;phone1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;phone2&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;phone3&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;phone4&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;phone5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入Properties"><a href="#注入Properties" class="headerlink" title="注入Properties"></a>注入Properties</h4><p>在注入时使用 <code>&lt;props&gt;</code> 标签和 <code>&lt;prop&gt;</code> 标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.DataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;driver&quot;</span>&gt;</span>com.cj.jc.sql.Driver<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;url&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/tes<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;username&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="注入空字符串和null值"><a href="#注入空字符串和null值" class="headerlink" title="注入空字符串和null值"></a>注入空字符串和null值</h4><p>空字符串可以是以下的方式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.OrderSerivce&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;world&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注入 <code>null</code> 可以不注入对应属性，也可以使用 <code>&lt;null&gt;</code> 标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderDaoBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.dao.OrderDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orderService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.OrderSerivce&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;orderDao&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="p命名空间注入"><a href="#p命名空间注入" class="headerlink" title="p命名空间注入"></a>p命名空间注入</h3><p>使用前确保使用约束：<code>xmlns:p=http://www.Springframework.org/schema/p</code></p>
<p>相当于 <code>set</code> 注入和在注入时使用 <code>&lt;property&gt;</code> 标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;stu&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.Student&quot;</span> <span class="attr">p:name</span>=<span class="string">&quot;llll&quot;</span> <span class="attr">p:clazz-ref</span>=<span class="string">&quot;clazz&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>该命名空间的形式为：<code>p:xxx[-ref]</code> <code>xxx</code> 为属性名，是否带 <code>ref</code> 取决于该属性是否为引用属性</p>
</blockquote>
<h3 id="c命名空间注入"><a href="#c命名空间注入" class="headerlink" title="c命名空间注入"></a>c命名空间注入</h3><p>使用前确保使用约束：<code>xmlns:p=http://www.Springframework.org/schema/c</code></p>
<p>相当于构造器注入和在注入时使用 <code>&lt;constructor-arg&gt;</code> ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;use&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.entity.User&quot;</span> <span class="attr">c:_0</span>=<span class="string">&quot;111&quot;</span> <span class="attr">c:name</span>=<span class="string">&quot;jjjj&quot;</span> <span class="attr">c_1-ref</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>该命名空间的形式为：<code>p:_num|xxx[-ref]</code> <code>_num</code> 相当于 <code>&lt;constructor-arg&gt;</code> 中的序号 <code>xxx</code> 相当于属性名，是否带 <code>ref</code> 取决于该属性是否为引用属性</p>
</blockquote>
<h3 id="util命名空间"><a href="#util命名空间" class="headerlink" title="util命名空间"></a>util命名空间</h3><p>使用 <code>util </code>命名空间可以让<strong>配置复用</strong>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">&quot;http://www.Springframework.org/schema/util&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans http://www.Springframework.org/schema/beans/Spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.Springframework.org/schema/util http://www.Springframework.org/schema/util/Spring-util.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	保证有下面连个约束：</span></span><br><span class="line"><span class="comment">	xmlns:util=&quot;http://www.Springframework.org/schema/util&quot;</span></span><br><span class="line"><span class="comment">	 xsi:schemaLocation=&quot;http://www.Springframework.org/schema/util http://www.Springframework.org/schema/util/Spring-util.xsd&quot;</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:properties</span> <span class="attr">id</span>=<span class="string">&quot;prop&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;driver&quot;</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;url&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/Spring<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;username&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:properties</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.powernode.Spring6.beans.MyDataSource1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;prop&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.powernode.Spring6.beans.MyDataSource2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;prop&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	引用某个类里面的公共，静态的变量作为bean</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:constant</span> <span class="attr">static-field</span>=<span class="string">&quot;java.lang.Integer.MAX_VALUE&quot;</span> <span class="attr">id</span>=<span class="string">&quot;aaa&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	相当于可复用的&lt;list&gt;标签</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">&quot;bbb&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>321<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1234567<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	相当于可复用的&lt;map&gt;标签</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">value</span>=<span class="string">&quot;world&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	相当于可复用的&lt;set&gt;标签</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">util:set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>321<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1234567<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">util:set</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于xml的自动装配"><a href="#基于xml的自动装配" class="headerlink" title="基于xml的自动装配"></a>基于xml的自动装配</h3><p>自动装配：不用显示地对类地引用对象进行赋值。使用 <code>&lt;bean&gt;</code> 标签的 <code>autowire</code> 属性。</p>
<h4 id="根据名称"><a href="#根据名称" class="headerlink" title="根据名称"></a>根据名称</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;aaa&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.UserService&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意根据名称自动注入装配，会根据 <code>id</code> 或 <code>name</code> 与 <code>setter</code> 方法匹配。所以 <code>id</code> 或 <code>name</code> 不能随便写。</p>
<p>没有 <code>name</code> 属性时会根据 <code>id</code> 进行匹配。</p>
<blockquote>
<p>此类型也是 <code>set</code> 注入，必须保证 <code>setter</code> 方法的存在</p>
</blockquote>
<h4 id="根据类型"><a href="#根据类型" class="headerlink" title="根据类型"></a>根据类型</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;aaa&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.dao.UserDao&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;customService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.di.service.CustomService&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意根据名称自动注入装配时，如果有多个相同类型的 <code>bean</code> 存在，那么无法进行自动装配，会抛出 <code>UnsatisfiedDependencyException</code> </p>
<blockquote>
<p>此类型也是 <code>set</code> 注入，必须保证 <code>setter</code> 方法的存在</p>
</blockquote>
<h3 id="引入外部属性配置文件"><a href="#引入外部属性配置文件" class="headerlink" title="引入外部属性配置文件"></a>引入外部属性配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.Springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans http://www.Springframework.org/schema/beans/Spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.Springframework.org/schema/context http://www.Springframework.org/schema/context/Spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	确保以下两个约束存在：</span></span><br><span class="line"><span class="comment">  	xmlns:context=&quot;http://www.Springframework.org/schema/context&quot;</span></span><br><span class="line"><span class="comment">	xsi:schemaLocation=&quot;http://www.Springframework.org/schema/context http://www.Springframework.org/schema/context/Spring-context.xsd&quot;</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--引入外部配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	使用$&#123;&#125;引用属性</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.powernode.Spring6.beans.MyDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="bean的作用域"><a href="#bean的作用域" class="headerlink" title="bean的作用域"></a>bean的作用域</h2><p>默认情况下 <code>bean</code> 是单例的。在 <code>Spring</code> 上下文初始化的时候实例化。通过 <code>&lt;bean&gt;</code> 标签的 <code>scope</code> 属性进行配置。</p>
<p><code>scope</code> 一个有 <code>8</code> 个取值：</p>
<ul>
<li><code>singleton</code>：默认的，单例。</li>
<li><code>prototype</code>：原型。每调用一次 <code>getBean()</code> 方法则获取一个新的 <code>Bean</code> 对象。或每次注入的时候都是新对象。</li>
<li><code>request</code>：一个请求对应一个 <code>Bean</code> 。<strong>仅限于在WEB应用中使用</strong>。</li>
<li><code>session</code>：一个会话对应一个 <code>Bean</code> 。<strong>仅限于在WEB应用中使用</strong>。</li>
<li><code>global session</code>：<strong>portlet应用中专用的</strong>。如果在 <code>Servlet</code> 的 <code>WEB</code> 应用中使用 <code>global session</code> 的话，和 <code>session</code> 一个效果。（ <code>portlet</code> 和 <code>servlet</code> 都是规范。servlet运行在servlet容器中，例如 <code>Tomcat</code> 。<code>portlet</code> 运行在 <code>portlet</code> 容器中。）</li>
<li><code>application</code>：一个应用对应一个 <code>Bean</code> 。<strong>仅限于在WEB应用中使用。</strong></li>
<li><code>websocket</code>：一个 <code>websocket</code> 生命周期对应一个 <code>Bean</code> 。<strong>仅限于在WEB应用中使用。</strong></li>
<li>自定义 <code>scope</code>：很少使用。</li>
</ul>
<h2 id="bean的创造"><a href="#bean的创造" class="headerlink" title="bean的创造"></a>bean的创造</h2><h3 id="通过构造方法实例化"><a href="#通过构造方法实例化" class="headerlink" title="通过构造方法实例化"></a>通过构造方法实例化</h3><p>默认情况下，<code>Spring</code> 会调用构造方法进行实例化</p>
<h3 id="通过简单工厂模式实例化"><a href="#通过简单工厂模式实例化" class="headerlink" title="通过简单工厂模式实例化"></a>通过简单工厂模式实例化</h3><p>如下所示，需要申明一个带有<strong>静态方法的工厂类</strong> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Star <span class="title function_">getStar</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Star</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后申明 <code>bean</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">注意申明的bean的class属性为该工厂类而不是产品类，且通过factory-method属性申明哪个方法作为产品类的生产方法</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.bean.SimpleStarFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;get&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后就可以通过 <code>id</code> 或者 <code>class</code> 获得 <code>bean</code></p>
<blockquote>
<p>如果要为 <code>factory-method</code> 转递参数，再 <code>bean</code> 中通过 <code>&lt;constructor-arg&gt;</code> 进行传递</p>
</blockquote>
<h3 id="通过factory-bean实例化"><a href="#通过factory-bean实例化" class="headerlink" title="通过factory-bean实例化"></a>通过factory-bean实例化</h3><p>如下所示，需要申明一个带有<strong>实例方法的工厂类</strong> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Star <span class="title function_">getStar</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Star</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后申明 <code>bean</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">首先要把该工厂类进行实例化，应为生产方法是实例方法</span></span><br><span class="line"><span class="comment">在产品类的bean中，在factory-bean属性中填入工厂类bean的id，表明对应的工厂类，其次使用factory-method属性申明生产产品类的生产方法</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;factory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.bean.StarFactory&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;star&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.bean.Star&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;factory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getStar&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后就可以通过 <code>id</code> 或者 <code>class</code> 获得 <code>bean</code></p>
<blockquote>
<p>如果要为 <code>factory-method</code> 转递参数，再 <code>bean</code> 中通过 <code>&lt;constructor-arg&gt;</code> 进行传递</p>
</blockquote>
<h3 id="通过FactoryBean接口实例化"><a href="#通过FactoryBean接口实例化" class="headerlink" title="通过FactoryBean接口实例化"></a>通过FactoryBean接口实例化</h3><p>如下所示，需要声明一个实现了 <code>FactoryBean</code> 接口的工厂类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductFactory</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Product&gt; &#123;</span><br><span class="line">    <span class="comment">//生产方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//返回对应的类型</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Product.class;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//判断是否单例。注意该方法时默认方法，返回true，也就是单例，如果不想为单例，则返回false</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> FactoryBean.<span class="built_in">super</span>.isSingleton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>随后申明 <code>bean</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">直接申明该工厂类，即可创造出对应产品类</span></span><br><span class="line"><span class="comment">如果，需要引用产品类直接引用该bean即可</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.bean.ProductFactory&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后就可以通过 <code>id</code> 或者 <code>class</code> 获得 <code>bean</code></p>
<blockquote>
<p>实例化 <code>FactoryBean</code> 接口的被成为 工厂 <code>bean</code> </p>
</blockquote>
<h4 id="BeanFactory和FactoryBean的区别"><a href="#BeanFactory和FactoryBean的区别" class="headerlink" title="BeanFactory和FactoryBean的区别"></a>BeanFactory和FactoryBean的区别</h4><h5 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h5><p><code>Spring IoC</code> 容器的顶级对象，<code>BeanFactory</code> 被翻译为“Bean工厂”，在 <code>Spring</code> 的 <code>IoC</code> 容器中，“Bean工厂”负责创建 <code>Bean</code> 对象。</p>
<p><code>BeanFactory</code> 是工厂。</p>
<h5 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h5><p><code>FactoryBean</code>：它是一个 <code>Bean</code> ，是一个能够<strong>辅助Spring</strong>实例化其它 <code>Bean</code> 对象的一个 <code>Bean</code> 。</p>
<p>在 <code>Spring</code> 中，<code>Bean</code> 可以分为两类：</p>
<ul>
<li>第一类：普通<code>Bean</code></li>
<li>第二类：工厂 <code>Bean</code>（记住：工厂 <code>Bean</code> 也是一种 <code>Bean</code> ，只不过这种 <code>Bean</code> 比较特殊，它可以辅助 <code>Spring</code> 实例化其它 <code>Bean</code> 对象。）</li>
</ul>
<h3 id="bean的生命周期"><a href="#bean的生命周期" class="headerlink" title="bean的生命周期"></a>bean的生命周期</h3><h4 id="什么是Bean的生命周期"><a href="#什么是Bean的生命周期" class="headerlink" title="什么是Bean的生命周期"></a>什么是Bean的生命周期</h4><p>Spring其实就是一个管理Bean对象的工厂。它负责对象的创建，对象的销毁等。</p>
<p>所谓的生命周期就是：对象从创建开始到最终销毁的整个过程。</p>
<p>什么时候创建Bean对象？创建Bean对象的前后会调用什么方法？Bean对象什么时候销毁？Bean对象的销毁前后调用什么方法？</p>
<h4 id="为什么要知道Bean的生命周期"><a href="#为什么要知道Bean的生命周期" class="headerlink" title="为什么要知道Bean的生命周期"></a>为什么要知道Bean的生命周期</h4><p>其实生命周期的本质是：<strong>在哪个时间节点上调用了哪个类的哪个方法。</strong></p>
<p>我们需要充分的了解在这个生命线上，都有哪些特殊的时间节点。只有我们知道了特殊的时间节点都在哪，到时我们才可以确定代码写到哪。我们可能需要在某个特殊的时间点上执行一段特定的代码，这段代码就可以放到这个节点上。当生命线走到这里的时候，自然会被调用。</p>
<blockquote>
<p>Bean生命周期的管理，可以参考 <code>Spring</code> 的源码： <strong><code>AbstractAutowireCapableBeanFactory</code> 类的 <code>doCreateBean()</code>方法 。</strong></p>
</blockquote>
<h4 id="Bean的生命周期之5步"><a href="#Bean的生命周期之5步" class="headerlink" title="Bean的生命周期之5步"></a>Bean的生命周期之5步</h4><p><code>Bean</code> 生命周期可以粗略的划分为五大步：</p>
<ul>
<li>第一步：实例化 <code>Bean</code></li>
<li>第二步：<code>Bean</code> 属性赋值</li>
<li>第三步：初始化 <code>Bean</code><ul>
<li>通过自定义一个方法进行初始化</li>
</ul>
</li>
<li>第四步：使用 <code>Bean</code></li>
<li>第五步：销毁 <code>Bean</code><ul>
<li>通过自定义一个方法进行销毁</li>
</ul>
</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="lifecycle5.png" alt="bean生命周期之5步"/>

<p>我们来看下面这个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们定义了一个类，该类含有两个特殊的方法，initBean用来初始化bean，destroyBean用来销毁bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第一步实例化bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第二步属性赋值&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s: &quot;</span>,<span class="string">&quot;第四步使用bean&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBean</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第三步初始化bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyBean</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第五步销毁bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义好这个类后，我们尝试将他注册为 <code>bean</code> ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">光自定义初始化和摧毁方法不行，我们要让Spring知道这是哪些方法，这样Spring才能准确的回调他们</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.lifecycle.User&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initBean&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyBean&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>随后我们从 <code>ioc</code> 容器中取出这个 <code>bean</code> 然后打印这个 <code>bean</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    ConfigurableApplicationContext ioc= <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;lifecycle.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> ioc.getBean(User.class);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="comment">//此方法用于关闭ioc容器，销毁方法只有在ioc容器关闭后才会回调</span></span><br><span class="line">    ioc.registerShutdownHook();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不出意外，你将会看到以下五个生命周期步骤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">第一步: 实例化bean</span><br><span class="line">第二步: 属性赋值</span><br><span class="line">第三步: 初始化</span><br><span class="line">第四步: 使用bean: User&#123;name=&#x27;123&#x27;&#125;</span><br><span class="line">第五步: 销毁bean</span><br></pre></td></tr></table></figure>

<h4 id="Bean的生命周期之7步"><a href="#Bean的生命周期之7步" class="headerlink" title="Bean的生命周期之7步"></a>Bean的生命周期之7步</h4><p>在以上的五步中，第三步是初始化Bean，如果你还想在<strong>初始化前</strong>和<strong>初始化后</strong>添加代码，可以加入<strong>“Bean后处理器”</strong>。就形成了七个生命周期步骤。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="lifecycle7.png" alt="bean生命周期之7步"/>

<p>我们重新创建一个 <code>LogBeanPostProcessor</code> 类并实现 <code>BeanPostProcessor</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第五步: BeanPostProcessor的after方法执行&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BeanPostProcessor.<span class="built_in">super</span>.postProcessAfterInitialization(bean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第三步: BeanPostProcessor的before方法执行&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BeanPostProcessor.<span class="built_in">super</span>.postProcessBeforeInitialization(bean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义好这个类后，我们尝试将他注册为 <code>bean</code> ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">这将为这个xml文件代表的ioc容器创建一个全局的Bean后处理器，任何bean都会触发</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.lifecycle.LogBeanPostProcessor&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>随后我们从 <code>ioc</code> 容器中取出 <code>user</code> 然后打印这个 <code>bean</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    ConfigurableApplicationContext ioc= <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;lifecycle.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> ioc.getBean(User.class);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="comment">//此方法用于关闭ioc容器，销毁方法只有在ioc容器关闭后才会回调</span></span><br><span class="line">    ioc.registerShutdownHook();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不出意外，你将会看到以下七个生命周期步骤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">第一步: 实例化bean</span><br><span class="line">第二步: 属性赋值</span><br><span class="line">第三步: BeanPostProcessor的before方法执行</span><br><span class="line">第四步: 初始化</span><br><span class="line">第五步: BeanPostProcessor的after方法执行</span><br><span class="line">第六步使用bean: User&#123;name=&#x27;123&#x27;&#125;</span><br><span class="line">第七步: 销毁bean</span><br></pre></td></tr></table></figure>

<h4 id="Bean的生命周期之10步"><a href="#Bean的生命周期之10步" class="headerlink" title="Bean的生命周期之10步"></a>Bean的生命周期之10步</h4><p>如果根据源码跟踪，可以划分更细粒度的步骤，我们通过 <code>*Aware</code> 接口、<code>InitializingBean</code> 接口和 <code>DisposableBean</code>来实现。</p>
<p><code>*Aware</code> 接口会在 <code>InitializingBean</code> 接口之前执行</p>
<p><code>InitializingBean</code> 接口会在初始方法调用前和 <code>BeanPostProcessor</code> 的 <code>before</code> 方法调用前执行。</p>
<p><code>DisposableBean</code> 接口会在销毁方法调用前和使用 <code>bean</code> 执行。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="lifecycle10.png" alt="bean生命周期之10步"/>

<p>仍然使用 <code>User</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">BeanNameAware</span>, BeanClassLoaderAware, BeanFactoryAware, InitializingBean, DisposableBean &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第一步: 实例化bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第二步: 属性赋值&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s: &quot;</span>,<span class="string">&quot;第八步使用bean&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBean</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第六步: 初始化&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyBean</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第十步: 销毁bean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//该方法为BeanClassLoaderAware的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第三步: BeanClassLoaderAware&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//该方法为BeanFactoryAware的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第三步: BeanFactoryAware&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//该方法为BeanNameAware的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第三步: BeanNameAware&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//该方法为DisposableBean的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第九步: destroy执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//该方法为InitializingBean的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第五步: afterPropertiesSet执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第七步: BeanPostProcessor的after方法执行&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BeanPostProcessor.<span class="built_in">super</span>.postProcessAfterInitialization(bean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第三步: BeanPostProcessor的before方法执行&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BeanPostProcessor.<span class="built_in">super</span>.postProcessBeforeInitialization(bean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义好这两个类后，我们尝试将他注册为 <code>bean</code> ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">这将为这个xml文件代表的ioc容器创建一个全局的Bean后处理器，任何bean都会触发</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.lifecycle.LogBeanPostProcessor&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">光自定义初始化和摧毁方法不行，我们要让Spring知道这是哪些方法，这样Spring才能准确的回调他们</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.lifecycle.User&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initBean&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyBean&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>随后我们从 <code>ioc</code> 容器中取出这个 <code>bean</code> 然后打印这个 <code>bean</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    ConfigurableApplicationContext ioc= <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;lifecycle.xml&quot;</span>);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> ioc.getBean(User.class);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="comment">//此方法用于关闭ioc容器，销毁方法只有在ioc容器关闭后才会回调</span></span><br><span class="line">    ioc.registerShutdownHook();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不出意外，你将会看到以下十个生命周期步骤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">第一步: 实例化bean</span><br><span class="line">第二步: 属性赋值</span><br><span class="line">第三步: BeanNameAware</span><br><span class="line">第三步: BeanClassLoaderAware</span><br><span class="line">第三步: BeanFactoryAware</span><br><span class="line">第四步: BeanPostProcessor的before方法执行</span><br><span class="line">第五步: afterPropertiesSet执行</span><br><span class="line">第六步: 初始化</span><br><span class="line">第七步: BeanPostProcessor的after方法执行</span><br><span class="line">第八步使用bean: User&#123;name=&#x27;123&#x27;&#125;</span><br><span class="line">第九步: destroy执行</span><br><span class="line">第十步: 销毁bean</span><br></pre></td></tr></table></figure>

<p><code>Spring</code> 提供了一系列的 <code>Aware</code> 回调接口，让 <code>Bean</code> 向容器表明它们需要某种基础设施的依赖性：</p>
<table>
<thead>
<tr>
<th align="left">接口名称</th>
<th align="left">注入的依赖性</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>ApplicationContextAware</code></td>
<td align="left">声明 <code>ApplicationContext</code>。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#beans-factory-aware">ApplicationContextAware 和 BeanNameAware</a></td>
</tr>
<tr>
<td align="left"><code>ApplicationEventPublisherAware</code></td>
<td align="left">封装了 <code>ApplicationContext</code> 的 Event publisher 。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#context-introduction">ApplicationContex 的附加功能</a></td>
</tr>
<tr>
<td align="left"><code>BeanClassLoaderAware</code></td>
<td align="left">用来加载Bean类的类加载器（Class loader）。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#beans-factory-class">实例化 Bean</a></td>
</tr>
<tr>
<td align="left"><code>BeanFactoryAware</code></td>
<td align="left">声明 <code>BeanFactory</code>。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#beans-beanfactory">BeanFactory API</a></td>
</tr>
<tr>
<td align="left"><code>BeanNameAware</code></td>
<td align="left">声明 <code>Bean</code> 的名称。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#beans-factory-aware">ApplicationContextAware 和 BeanNameAware</a></td>
</tr>
<tr>
<td align="left"><code>LoadTimeWeaverAware</code></td>
<td align="left">定义了用于在加载时处理类定义的织入点。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#aop-aj-ltw">在Spring框架中用AspectJ进行加载时织入（Load-time Weaving）</a></td>
</tr>
<tr>
<td align="left"><code>MessageSourceAware</code></td>
<td align="left">配置解析消息的策略（支持参数化和国际化）。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#context-introduction">ApplicationContext 的附加功能</a></td>
</tr>
<tr>
<td align="left"><code>NotificationPublisherAware</code></td>
<td align="left"><code>Spring JMX notification publisher</code>。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/integration.html#jmx-notifications">Notifications</a></td>
</tr>
<tr>
<td align="left"><code>ResourceLoaderAware</code></td>
<td align="left">配置的加载器用于低级别的资源访问。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/core.html#resources">资源（Resources）</a></td>
</tr>
<tr>
<td align="left"><code>ServletConfigAware</code></td>
<td align="left">容器所运行的当前 <code>ServletConfig</code>。仅在 Web 感知的 Spring <code>ApplicationContext</code> 中有效。</td>
<td align="left"><a target="_blank" rel="noopener" href="https://springdoc.cn/Spring/web.html#mvc">Spring MVC</a></td>
</tr>
</tbody></table>
<h4 id="不同作用域的生命周期"><a href="#不同作用域的生命周期" class="headerlink" title="不同作用域的生命周期"></a>不同作用域的生命周期</h4><p>对于 <code>singleton</code> 作用域的 <code>Bean</code>，<code>Spring</code> 能够精确地知道该 <code>Bean</code> 何时被创建，何时初始化完成，以及何时被销毁；</p>
<p>而对于 <code>prototype</code> 作用域的 <code>Bean</code> ，<code>Spring</code> 只负责创建，当容器创建了 <code>Bean</code> 的实例并初始化后，<code>Bean</code> 的实例就交给客户端代码管理，<code>Spring</code> 容器将不再跟踪其生命周期。</p>
<p>依然是上面的 <code>user</code> 类，我们将这个类的作用域转换为 <code>prototype</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">第一步: 实例化bean</span><br><span class="line">第二步: 属性赋值</span><br><span class="line">第三步: BeanNameAware</span><br><span class="line">第三步: BeanClassLoaderAware</span><br><span class="line">第三步: BeanFactoryAware</span><br><span class="line">第三步: ApplicationContextAware</span><br><span class="line">第四步: BeanPostProcessor的before方法执行</span><br><span class="line">第五步: afterPropertiesSet执行</span><br><span class="line">第六步: 初始化</span><br><span class="line">第七步: BeanPostProcessor的after方法执行</span><br><span class="line">第八步: 使用bean: User&#123;name=&#x27;123&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到只执行到了第八步，也就是说 <code>Spring</code> 不再管理其的销毁程序。</p>
<h4 id="将自己实例化的对象加入到IoC容器"><a href="#将自己实例化的对象加入到IoC容器" class="headerlink" title="将自己实例化的对象加入到IoC容器"></a>将自己实例化的对象加入到IoC容器</h4><p>可以通过 <code>getBeanFactory()</code> 方法访问 <code>ApplicationContext</code> 的 <code>BeanFactory</code> 来实现，该方法返回 <code>DefaultListableBeanFactory</code> 实现。<code>DefaultListableBeanFactory</code> 通过 <code>registerSingleton(..)</code> 和 <code>registerBeanDefinition(..)</code> 方法支持这种注册。</p>
<h3 id="bean的循环依赖"><a href="#bean的循环依赖" class="headerlink" title="bean的循环依赖"></a>bean的循环依赖</h3><p>当我们创建 <code>bean</code> 的时候可能会遇到这个问题：两个对象互相依赖了对方，即 <code>A</code> 的属性包括 <code>B</code> , <code>B</code> 的属性包括了 <code>A</code>。</p>
<p>我们创建下面两个类 <code>Wife</code> 和 <code>Husband</code> 类：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="huswife.png" alt="Husband类和Wife类的关系">

<p>由该图可知 <code>Husband</code> 和 <code>Wife</code> 构成了循环依赖</p>
<p>代码如下： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Husband</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Wife wife;</span><br><span class="line">    <span class="comment">// toString()方法重写时需要注意：不能直接输出wife，输出wife.getName()。要不然会出现递归导致的栈内存溢出错误。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Husband&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, wife=&quot;</span> + wife.getName() +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Wife</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Husband husband;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// toString()方法重写时需要注意：不能直接输出husband，输出husband.getName()。要不然会出现递归导致的栈内存溢出错误。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Wife&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, husband=&quot;</span> + husband.getName() +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们将其配置成 <code>bean</code> ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;husband&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.cycle.bean.Husband&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hello&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;wife&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;wife&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.jhy.cycle.bean.Wife&quot;</span> <span class="attr">id</span>=<span class="string">&quot;wife&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;world&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;husband&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;husband&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过 <code>ioc</code> 容器获取这两个 <code>bean</code> 后，我们打印这两个类，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Husband&#123;name=&#x27;hello&#x27;, wife=world&#125;</span><br><span class="line">Wife&#123;name=&#x27;world&#x27;, husband=hello&#125;</span><br></pre></td></tr></table></figure>

<p>可见这两个对象的属性都分配成功，<code>Spring</code> 成功解决了循环依赖问题，为什么会这样呢？</p>
<p>在上述情况下我们使用的是 <code>singleton</code> 和 <code>set</code> 注入的情况，下节将会回答这个问题。</p>
<h4 id="set注入的情况"><a href="#set注入的情况" class="headerlink" title="set注入的情况"></a>set注入的情况</h4><h5 id="全部为singleton"><a href="#全部为singleton" class="headerlink" title="全部为singleton"></a>全部为singleton</h5><p>在此情况下 <code>Spring</code> 将 <code>bean</code> 的创建分成两个步骤：</p>
<ol>
<li><code>Spring</code> 会先将 <code>bean</code> 实例化了出来，此时 <code>bean</code> 的各个属性都没有赋值，处于“曝光”状态，意味着此时 <code>bean</code> 已经可以被其他 <code>bean</code> 知晓并使用。</li>
<li>被创建出来的 <code>bean</code> 通过 <code>setter</code> 方法进行赋值。</li>
</ol>
<p>因此，两个单例的 <code>bean</code> 再进行属性赋值的时候全部都已经存在，所以才不会存在循环依赖的问题。</p>
<p><code>Spring</code> 官方文档如下解释说：</p>
<blockquote>
<p>当容器被创建时，<code>Spring</code> 容器会验证每个 <code>Bean</code> 的配置。然而，在实际创建 <code>Bean</code> 之前，<code>Bean</code> 的属性本身不会被设置。当容器被创建时，那些具有单例作用域并被设置为预实例化的 <code>Bean</code>（默认）被创建。创建 <code>bean</code> 有可能导致创建 <code>bean</code> 图（graph），因为 <code>bean</code> 的依赖关系和它的依赖关系（等等）被创建和分配。请注意，这些依赖关系之间的解析不匹配可能会出现得很晚—也就是说，在第一次创建受影响的 <code>Bean</code> 时。</p>
</blockquote>
<h5 id="单个为singleton"><a href="#单个为singleton" class="headerlink" title="单个为singleton"></a>单个为singleton</h5><p>下面我们将 <code>wife bean</code> 改为 <code>prototype</code> ，再次运行观察结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Husband&#123;name=&#x27;hello&#x27;, wife=world&#125;</span><br><span class="line">Wife&#123;name=&#x27;world&#x27;, husband=hello&#125;</span><br></pre></td></tr></table></figure>

<p>仍然运行成功。可见，只要两个 <code>bean</code> 的作用域有一个为单例即可解决循环依赖问题。</p>
<p>我们知道作用域处于 <code>prototype</code> 的 <code>bean</code> 只有在被需要的时候才会被创建，所以当单例的 <code>bean</code> 需要一个原型的 <code>bean</code> 时，该原型的 <code>bean</code> 才会被创建，而该原型 <code>bean</code> 需要单例的 <code>bean</code> 的时候，该单例 <code>bean</code> 早已存在，所以循环依赖问题不会发生。</p>
<h5 id="全部为prototype"><a href="#全部为prototype" class="headerlink" title="全部为prototype"></a>全部为prototype</h5><p>作用域处于 <code>prototype</code> 的 <code>bean</code> 只有在被需要的时候才会被创建，且会返回不同的实例。我们以上面的 <code>Wife</code> 和 <code>Husband</code> 举例。</p>
<p>所以当 <code>Wife</code> 创建的时候，会去创建另一个 <code>Husband</code> ；而当 <code>Husband</code> 创建时，会创建另一个 <code>Wife</code> 。由于原型每次创建新的 <code>bean</code> 的特性，每次创建的 <code>Husband</code> 和 <code>Wife</code> 都不相同，所以会一直创建下去。循环依赖问题并不会解决</p>
<p>当我们将 <code>bean</code> 的作用域全部改为 <code>prototype</code> ，再次运行时会发现，程序抛出了下面的异常：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.BeanCurrentlyInCreationException: </span><br><span class="line">Error creating bean with name &#x27;husband&#x27;: </span><br><span class="line">Requested bean is currently in creation: Is there an unresolvable circular reference?</span><br></pre></td></tr></table></figure>

<p>代表着循环依赖问题并没有解决</p>
<h4 id="构造器注入的情况"><a href="#构造器注入的情况" class="headerlink" title="构造器注入的情况"></a>构造器注入的情况</h4><p>上面说过，只有实例化和注入的步骤分开的时候，循环依赖的情况才会解决，所以当使用构造器注入的时候，是实例化和注入同时进行，此时依赖的 <code>bean</code> 并没有创建，所以也不存在能解决循环问题的办法。因此，构造器注入无法解决循环依赖问题。</p>
<p>我们将注入改为构造器注入，运行后仍然会发现，程序抛出了 <code>BeanCreationException</code> 异常：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.Springframework.beans.factory.BeanCreationException: </span><br><span class="line">Error creating bean with name &#x27;husband&#x27; defined in class path resource [Spring.xml]: </span><br><span class="line">Cannot resolve reference to bean &#x27;wife&#x27; while setting constructor argument</span><br></pre></td></tr></table></figure>

<h4 id="三级依赖解决循环依赖-源码"><a href="#三级依赖解决循环依赖-源码" class="headerlink" title="三级依赖解决循环依赖(源码)"></a>三级依赖解决循环依赖(源码)</h4><p>注意解决循环依赖问题建立在：单例和 <code>set</code> 注入的情况下。</p>
<p>让我们进入： <strong><code>AbstractAutowireCapableBeanFactory</code> 类的 <code>doCreateBean()</code>方法</strong> ，所有的单例 <code>bean</code> 都在这里创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">			<span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Instantiate the bean.下面就是在实例化bean</span></span><br><span class="line">		<span class="type">BeanWrapper</span> <span class="variable">instanceWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">			instanceWrapper = <span class="built_in">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (instanceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">			instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> instanceWrapper.getWrappedInstance(); <span class="comment">//该方法就是已经获得了实例化的bean，此时该bean的所有属性均没有被赋值</span></span><br><span class="line">		Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass(); </span><br><span class="line">		<span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">			mbd.resolvedTargetType = beanType;</span><br><span class="line">		&#125;</span><br><span class="line">		......</span><br><span class="line">		<span class="comment">//注意下面的代码块</span></span><br><span class="line">		<span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">    	<span class="comment">// 急切地缓存单例以便能够解决循环依赖</span></span><br><span class="line">		<span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">    	<span class="comment">// 甚至当被如BeanFactoryAware生命周期接口触发地时候</span></span><br><span class="line">		<span class="type">boolean</span> <span class="variable">earlySingletonExposure</span> <span class="operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="built_in">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">				isSingletonCurrentlyInCreation(beanName)); <span class="comment">//判断是否要解决循环依赖问题</span></span><br><span class="line">		<span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">						<span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">//解决循环依赖地问题地办法就在这里，该方法位于DefaultSingletonBeanRegistry，让我们进入这个方法.....</span></span><br><span class="line">			addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">		&#125;</span><br><span class="line">		......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>addSingletonFactory</code>方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> &#123;</span><br><span class="line">		Assert.notNull(singletonFactory, <span class="string">&quot;Singleton factory must not be null&quot;</span>);</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="built_in">this</span>.singletonObjects) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">this</span>.singletonObjects.containsKey(beanName)) &#123; </span><br><span class="line">                <span class="comment">/** 我们重点看这个表达式，它将bean的名字和创建这个bean的工厂放进了一个map集合里，</span></span><br><span class="line"><span class="comment">                也就是将这个对象提前曝光。这个map集合就是我们待会儿要说的三级缓存之一*/</span></span><br><span class="line">				<span class="built_in">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">				<span class="built_in">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">				<span class="built_in">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>下面就是 <code>DefaultSingletonBeanRegistry</code> 类的三个map集合属性，也就是–三级缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Cache of singleton factories: bean name to ObjectFactory. */</span></span><br><span class="line"><span class="comment">//三级缓存，单例工厂缓存。是bean名字和bean工厂的map集合。缓存创造对应bean的单例工厂，</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of early singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="comment">//二级缓存，预实例化对象的缓存。是bean名字和预实例化的bean的map集合。缓存对应的属性未赋值的bean</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cache of singleton objects: bean name to bean instance. */</span></span><br><span class="line"><span class="comment">//一级缓存，单例对象的缓存。是bean名字和实例化后的bean的map集合。缓存对应的属性已经赋值的bean，也就是对象本身了。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">256</span>);</span><br></pre></td></tr></table></figure>

<p>了解了三级缓存后，我们来到该类的另外一个方法 <code>getSingleton</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName, <span class="type">boolean</span> allowEarlyReference)</span> &#123;</span><br><span class="line">    <span class="comment">// 下面就是解决循环依赖的办法</span></span><br><span class="line">    <span class="comment">// Quick check for existing instance without full singleton lock</span></span><br><span class="line">    <span class="comment">//首先会从一级缓存中取该单例对象，看是否能取到</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">singletonObject</span> <span class="operator">=</span> <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="comment">//没有取到则去二级缓存取预实例化的单例对象</span></span><br><span class="line">        singletonObject = <span class="built_in">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>.singletonObjects) &#123;</span><br><span class="line">                <span class="comment">// Consistent creation of early reference within full singleton lock</span></span><br><span class="line">                singletonObject = <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;              </span><br><span class="line">                    singletonObject = <span class="built_in">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//最终都没有的话去三级缓存中去该对象的bean工厂</span></span><br><span class="line">                        ObjectFactory&lt;?&gt; singletonFactory = <span class="built_in">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                        <span class="keyword">if</span> (singletonFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//然后通过该bean工厂回去对应的bean</span></span><br><span class="line">                            singletonObject = singletonFactory.getObject();</span><br><span class="line">                        <span class="comment">//加入二级缓存</span></span><br><span class="line">                            <span class="built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                        <span class="comment">//随后将该工厂移除</span></span><br><span class="line">                            <span class="built_in">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基于注解的Ioc开发"><a href="#基于注解的Ioc开发" class="headerlink" title="基于注解的Ioc开发"></a>基于注解的Ioc开发</h2><p><code>Spring</code> 提供了注解 + 扫描的方式来替代 <code>xml</code> 配置</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>现在让我们创建一个注解 <code>@Component</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将这个注解加到一个类上去</span></span><br><span class="line"><span class="meta">@Component(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果当我获得了这个类的包名并且想让标注了这个注解的类能被实例化，并添加至一个map集合里，那我们应该怎么做？答案是使用反射：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testComponentScan</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> <span class="string">&quot;com.jhy.bean&quot;</span>; <span class="comment">//包名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">packagePath</span> <span class="operator">=</span> packageName.replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>); <span class="comment">//将包名改成路径</span></span><br><span class="line"></span><br><span class="line">        <span class="type">URL</span> <span class="variable">resource</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader().getResource(packagePath);</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> resource.getPath();</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path); <span class="comment">//获得磁盘路径的File对象</span></span><br><span class="line">        File[] files = file.listFiles(); <span class="comment">//查找该路径下的所有文件</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//循环遍历</span></span><br><span class="line">        Arrays.stream(files).forEach(f -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> packageName + <span class="string">&quot;.&quot;</span> + f.getName().split(<span class="string">&quot;\\.&quot;</span>)[<span class="number">0</span>]; <span class="comment">//获得类的全限定名</span></span><br><span class="line">            Class&lt;?&gt; aClass = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                aClass = Class.forName(className); <span class="comment">//获得该类的字节码对象</span></span><br><span class="line">                <span class="keyword">if</span> (aClass.isAnnotationPresent(Component.class)) &#123; <span class="comment">//判断是否标注了注解，标注了注解就通过反射实例化</span></span><br><span class="line">                    <span class="type">Component</span> <span class="variable">annotation</span> <span class="operator">=</span> aClass.getAnnotation(Component.class);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> annotation.value(); <span class="comment">//获得注解的值</span></span><br><span class="line">                    Constructor&lt;?&gt; constructor = aClass.getConstructor();</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> constructor.newInstance(); <span class="comment">//实例化</span></span><br><span class="line">                    map.put(value,target); <span class="comment">//添加到一个map集合里</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(map); <span class="comment">//打印集合</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;user=com.jhy.bean.User@e580929&#125;</span><br></pre></td></tr></table></figure>

<p>如果你将这个注解添加至包下的更多类上，那么map结合中将会包含所有被标注了这个注解的实例。</p>
<p>如上就是 <code>IoC</code> 的注解开发的原理：扫描包下的所有类，将所有标注了指定注解的类通过反射调用进行实例化。</p>
<h3 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h3><p><code>Spring</code> 提供了四个注解来进行注解开发：</p>
<ul>
<li><code>@Component</code>：注解普通的类</li>
<li><code>@Controller</code>：注解表示层的类</li>
<li><code>@Service</code>：注解业务层的类</li>
<li><code>@Repository</code>：注解数据访问层的类</li>
</ul>
<p>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Indexed</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The value may indicate a suggestion for a logical component name,</span></span><br><span class="line"><span class="comment">	 * to be turned into a Spring bean name in case of an autodetected component.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the suggested component name, if any (or empty String otherwise)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Controller &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Alias for &#123;<span class="doctag">@link</span> Component#value&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor(annotation = Component.class)</span></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Service &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Alias for &#123;<span class="doctag">@link</span> Component#value&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor(annotation = Component.class)</span></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Repository &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Alias for &#123;<span class="doctag">@link</span> Component#value&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor(annotation = Component.class)</span></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>除 <code>@Conponent</code> 的三个注解都被 <code>@Componet</code> 注解了，因此其余三个注解都是 <code>@Component</code> 的衍生注解，功能一样。</p>
</blockquote>
<p>上述注解的 <code>value()</code> 属性代表该类实例化后的 <code>id</code> 或者 <code>name</code> ，如果省略，则以该类的首字母小写的类名作为实例化后的 <code>id</code> 或者 <code>name</code> 。</p>
<h4 id="使用注解"><a href="#使用注解" class="headerlink" title="使用注解"></a>使用注解</h4><p>前面提到基于注解的 <code>IoC</code> 开发时采用的扫描 + 反射的原理进行的。所以，注解存在，下面我们来进行扫描：</p>
<p>如果使用 <code>xml</code> 进行扫描，就要使用 <code>context</code> 命名空间下的标签了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span> = <span class="string">&quot;http://www.Springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.Springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.Springframework.org/schema/beans/Spring-beans.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.Springframework.org/schema/context http://www.Springframework.org/schema/context/Spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	使用context确保下面的约束存在</span></span><br><span class="line"><span class="comment">	xmlns:context = &quot;http://www.Springframework.org/schema/context&quot;</span></span><br><span class="line"><span class="comment">	 xsi:schemaLocation =  &quot;http://www.Springframework.org/schema/context </span></span><br><span class="line"><span class="comment">							http://www.Springframework.org/schema/context/Spring-context.xsd&quot;</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	component-scan专门用来进行扫描</span></span><br><span class="line"><span class="comment">	base-package则为扫描的包的范围，如果要扫描多个包，可以用逗号，分号，空格等进行分割</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package则为扫描的包</span>=<span class="string">&quot;com.jhy.anno.beans&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	如果你想选择性实例化一些Bean，可以禁用默认的包扫描过滤器：use-default-filters=&quot;false“，use-default-filters默认是true</span></span><br><span class="line"><span class="comment">	然后自己去设计自定义的包含过滤器：&lt;context:include-filter&gt;用来指定包含的过滤器，type指定包含策略，expression指定策略的详细信息</span></span><br><span class="line"><span class="comment">	如下的内容表示将会让被@Repository注解的类注册为bean</span></span><br><span class="line"><span class="comment">	请注意：&lt;context:include-filter&gt;必须和use-default-filters=&quot;false&quot;使用才会生效</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package则为扫描的包</span>=<span class="string">&quot;com.jhy.anno.beans&quot;</span>  <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    	 <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.Springframework.stereotype.Repository&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	如果你想选择性实例化一些Bean，也可以选择自定义排除过滤器，排除过滤器和use-default-filters=&quot;true&quot;一起工作</span></span><br><span class="line"><span class="comment">	当然，use-default-filters默认为true，所以可以不写</span></span><br><span class="line"><span class="comment">	&lt;context:exclude-filter&gt;排除过滤器 type指定排除策略，expression指定策略的详细信息</span></span><br><span class="line"><span class="comment">	如下的内容表示不会将被@Service标注的类注解为bean</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package则为扫描的包</span>=<span class="string">&quot;com.jhy.anno.beans&quot;</span>&gt;</span></span><br><span class="line">    	 <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.Springframework.stereotype.Service&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如下为排除过滤器和包含过滤器的一些详细信息：</p>
<table>
<thead>
<tr>
<th align="left">Filter Type</th>
<th align="left">示例表达式</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">注解(annotation) (默认)</td>
<td align="left"><code>org.example.SomeAnnotation</code></td>
<td align="left">一个注解在目标组件中的类型级别是 <em>present</em> 或 <em>meta-present</em>。</td>
</tr>
<tr>
<td align="left">可指定(assignable)</td>
<td align="left"><code>org.example.SomeClass</code></td>
<td align="left">目标组件可分配给（继承或实现）的一个类（或接口）。</td>
</tr>
<tr>
<td align="left">aspectj</td>
<td align="left"><code>org.example..*Service+</code></td>
<td align="left">要被目标组件匹配的 AspectJ type 表达式。</td>
</tr>
<tr>
<td align="left">regex</td>
<td align="left"><code>org\.example\.Default.*</code></td>
<td align="left">一个与目标组件的类名相匹配的 regex expression。</td>
</tr>
<tr>
<td align="left">自定义(custom)</td>
<td align="left"><code>org.example.MyTypeFilter</code></td>
<td align="left"><code>org.Springframework.core.type.TypeFilter</code> 接口的自定义实现。</td>
</tr>
</tbody></table>
<h4 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h4><p>与 <code>xml</code> 的自动装配一样，注解式开发也提供了用于自动装配的注解</p>
<h5 id="Value"><a href="#Value" class="headerlink" title="@Value"></a>@Value</h5><p><code>@Value</code> 用于简单类型的自动装配：</p>
<p><code>@Value</code> 的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.ANNOTATION_TYPE&#125;)</span> <span class="comment">//可以注解：属性、方法、参数、注解</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Value &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The actual value expression such as &lt;code&gt;#&#123;systemProperties.myProp&#125;&lt;/code&gt;</span></span><br><span class="line"><span class="comment">	 * or property placeholder such as &lt;code&gt;$&#123;my.app.myProp&#125;&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span>; <span class="comment">//代表传入的简单类型字面值</span></span><br></pre></td></tr></table></figure>

<p>实例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;123&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(<span class="meta">@Value(&quot;789&quot;)</span> String name)</span> &#123; <span class="comment">//通过构造器初始化</span></span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;456&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@Value</code>：可以出现在：属性、构造器参数和 <code>setter</code> 方法上。注意当 <code>@Value</code> 出现在属性上时，不需要 <code>setter</code> 方法，因为反射的机理，导致能通过反射拿到值</p>
</blockquote>
<h5 id="Autowired和-Qualifier"><a href="#Autowired和-Qualifier" class="headerlink" title="@Autowired和@Qualifier"></a>@Autowired和@Qualifier</h5><p><code>@Autowired</code> 用来注解“非简单类型”– <code>Spring</code> 所认为的。</p>
<p><code>@Autowired</code> 的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.CONSTRUCTOR, ElementType.METHOD, ElementType.PARAMETER, ElementType.FIELD, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="comment">//能注解：构造器、方法、参数、属性、注解</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Autowired &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Declares whether the annotated dependency is required.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Defaults to &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>; <span class="comment">//该属性代表该属性是否需要，默认为true则代表需要，也就是没找到能够注入的bean则会报错，如果为false则不会</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(<span class="meta">@Autowired</span> UserDao userDao)</span> &#123; <span class="comment">//通过构造器实例化</span></span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserDao <span class="title function_">getUserDao</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserDao</span><span class="params">(<span class="meta">@Autowired</span> UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">()</span>&#123;</span><br><span class="line">        userDao.saveUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>特别的，当属性的名字和构造方法的参数名相同，且只有一个构造方法，那么不使用 <code>@Autowired</code> 也能完成自动装配：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserDao userDao)</span> &#123; <span class="comment">//通过构造器实例化</span></span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@Autowired</code> 能够注解在：属性、构造方法、参数、<code>setter</code> 方法。且当 <code>@Autowired</code> 出现在属性上时，同样也不需要 <code>setter</code> 方法。</p>
<p>且注意 <code>@Autowired</code> 默认只能使用 <code>byType</code> 查找 <code>bean</code> ，所以当容器中有多个相同类型的 <code>bean</code> 出现时，单使用 <code>@Autowired</code> 会报错。</p>
</blockquote>
<p> 于是如果你想让 <code>@Autowired</code> 根据 <code>byName</code> 的方式查找 <code>bean</code> 的话，那么要和 <code>@Qualifier</code> 进行搭配使用。</p>
<p><code>@Qualifier</code> 的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class="line"><span class="comment">//能够注解属性、方法、参数、类型</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Qualifier &#123;</span><br><span class="line"></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>; <span class="comment">//代表某个bean的id</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;userDaoMysql&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> IUerDao userDao;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样就会根据名字去查找 <code>id</code> 为 <code>userDaoMysql</code> 的 <code>bean</code></p>
</blockquote>
<p>或者如果你仍然想使用 <code>byType</code> 的方式查找那么可以使用 <code>@Primary</code> 注解</p>
<h5 id="Primary"><a href="#Primary" class="headerlink" title="@Primary"></a>@Primary</h5><p>因为按类型自动注入可能会导致多个候选者，所以经常需要对选择过程进行更多的控制。实现这一目标的方法之一是使用 <code>Spring</code> 的 <code>@Primary</code> 注解。<code>@Primary</code> 表示，当多个<code>bean</code> 是自动注入到一个单值（<code>single value</code>）依赖的候选者时，应该优先考虑一个特定的 <code>bean</code>。如果在候选者中正好有一个主要（<code>primary</code>）<code>bean</code>存在，它就会成为自动注入的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span> <span class="comment">//可以标注类型、方法</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Primary &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Resource"><a href="#Resource" class="headerlink" title="@Resource"></a>@Resource</h5><p><code>@Resource</code> 注解也可以完成非简单类型注入。他有以下的特性：</p>
<ul>
<li><code>@Resource</code> 注解是 <code>JDK</code> 扩展包中的，也就是说属于 <code>JDK</code> 的一部分。所以该注解是标准注解，更加具有通用性。(JSR-250标准中制定的注解类型。JSR是Java规范提案。)</li>
<li><strong><code>@Resource</code>注解默认根据名称装配 <code>byName</code> ，未指定 <code>name</code> 时，使用属性名作为 <code>name</code> 。通过 <code>name</code> 找不到的话会自动启动通过类型 <code>byType</code> 装配。</strong></li>
<li><code>@Resource</code> 注解用在属性上、<code>setter</code> 方法上。</li>
</ul>
<p>由于 <code>oracle</code> 在 <code>jdk9</code> 的时候将 <code>java ee</code> 捐献给了 <code>Apache</code> 基金会，并且改名 <code>jartarka ee</code> ，所以引入如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>@Resource</code> 的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;TYPE, FIELD, METHOD&#125;)</span> <span class="comment">//能注解类型、属性、方法</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="meta">@Repeatable(Resources.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Resource &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The JNDI name of the resource.  For field annotations,</span></span><br><span class="line"><span class="comment">     * the default is the field name.  For method annotations,</span></span><br><span class="line"><span class="comment">     * the default is the JavaBeans property name corresponding</span></span><br><span class="line"><span class="comment">     * to the method.  For class annotations, there is no default</span></span><br><span class="line"><span class="comment">     * and this must be specified.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>; <span class="comment">//name属性用来接受bean的名称</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全注解式开发"><a href="#全注解式开发" class="headerlink" title="全注解式开发"></a>全注解式开发</h3><p>通过配置类取代 <code>xml</code> 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.Springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.Springframework.context.annotation.ComponentScans;</span><br><span class="line"><span class="keyword">import</span> org.Springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//代表此类为一个配置类。</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.jhy.Spring6.dao&quot;, &quot;com.jhy.Spring6.service&quot;&#125;)</span> <span class="comment">//扫描包结构</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spring6Configuration</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Configuration</code> 的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//@Configuration 被 @Component注解，代表该注解表示的类也会被注册为bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br><span class="line">	<span class="meta">@AliasFor(annotation = Component.class)</span></span><br><span class="line">	String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>; <span class="comment">//bean的名称</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前的 <code>ClassPathXmlApplicationContext</code> 也被 <code>AnnotationConfigApplicationContext</code> 取代：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(MyConfiguration.class); <span class="comment">//MyConfiguration.class为配置类的字节码对象</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Java的容器配置"><a href="#基于Java的容器配置" class="headerlink" title="基于Java的容器配置"></a>基于Java的容器配置</h3><p>上面我们介绍了如何通过配置类的方式取代 <code>xml</code> 文件，那么下面我们介绍如何通过配置类配置 <code>bean</code> 以及一些额外信息。</p>
<p><code>Spring</code> 的 <code>Java</code> 配置支持的核心工件是 <code>@Configuration</code> 注解的类和 <code>@Bean</code> 注解的方法。</p>
<p><code>@Bean</code> 注解用来表示一个方法实例化、配置和初始化了一个新的对象，由 <code>Spring IoC</code> 容器管理。<code>@Bean</code> 注解的作用与 <code>&lt;bean&gt;</code> 元素的作用相同。你可以在任何 <code>Spring</code> <code>@Component</code> 中使用 <code>@Bean</code> 注解的方法。然而，它们最常被用于 <code>@Configuration</code> <code>bean</code>。</p>
<p>用 <code>@Configuration</code> 来注解一个类，表明它的主要目的是作为 <code>bean</code> 定义的来源。此外， <code>@Configuration</code> 类允许通过调用同一个类中的其他 <code>@Bean</code> 方法来定义 <code>bean</code> 间的依赖关系。最简单的 <code>@Configuration</code> 类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyServiceImpl <span class="title function_">myService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyServiceImpl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面的 <code>AppConfig</code> 类等同于下面的 Spring <code>&lt;beans/&gt;</code> XML。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.acme.services.MyServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="使用-Bean注解"><a href="#使用-Bean注解" class="headerlink" title="使用@Bean注解"></a>使用@Bean注解</h4><p><code>@Bean</code> 是一个方法级注解，是XML <code>&lt;bean/&gt;</code> 元素的直接类似物。该注解支持 <code>&lt;bean/&gt;</code> 所提供的一些属性，例如：</p>
<ul>
<li><a href="#%E6%8E%A5%E6%94%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E5%9B%9E%E8%B0%83">init-method</a></li>
<li><a href="#%E6%8E%A5%E6%94%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E5%9B%9E%E8%B0%83">destroy-method</a></li>
<li>[autowiring](#Bean 依赖)</li>
<li><code>name</code></li>
</ul>
<p>你可以在 <code>@Configuration</code> 或 <code>@Component</code> 注解的类中使用 <code>@Bean</code> 注解。</p>
<h5 id="声明一个-Bean"><a href="#声明一个-Bean" class="headerlink" title="声明一个 Bean"></a>声明一个 Bean</h5><p>为了声明一个Bean，你可以用 <code>@Bean</code> 注解来注解一个方法。你可以用这个方法在 <code>ApplicationContext</code> 中注册一个Bean定义，该类型被指定为该方法的返回值。默认情况下，Bean的名字和方法的名字是一样的。下面的例子显示了一个 <code>@Bean</code> 方法声明。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TransferServiceImpl <span class="title function_">transferService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransferServiceImpl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面的配置完全等同于下面的Spring XML。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transferService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.acme.TransferServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这两个声明使 <code>ApplicationContext</code> 中一个名为 <code>transferService</code> 的Bean可用，并与 <code>TransferServiceImpl</code> 类型的对象实例绑定，正如下面的文字图片所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transferService -&gt; com.acme.TransferServiceImpl</span><br></pre></td></tr></table></figure>

<p>你也可以使用 <code>default</code> 方法来定义 <code>bean</code>。这允许通过在默认方法上实现带有 <code>bean</code> 定义的接口来组成 <code>bean</code> 配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">default</span> TransferServiceImpl <span class="title function_">transferService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransferServiceImpl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> <span class="keyword">implements</span> <span class="title class_">BaseConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你也可以用一个接口（或基类）的返回类型来声明你的 <code>@Bean</code> 方法，如下例所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TransferService <span class="title function_">transferService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransferServiceImpl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Bean-依赖"><a href="#Bean-依赖" class="headerlink" title="Bean 依赖"></a>Bean 依赖</h5><p>一个 <code>@Bean</code> 注解的方法可以有任意数量的参数，描述构建该 <code>bean</code> 所需的依赖关系。例如，如果我们的 <code>TransferService</code> 需要一个 <code>AccountRepository</code>，我们可以用一个方法参数将这种依赖关系具体化，如下例所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TransferService <span class="title function_">transferService</span><span class="params">(AccountRepository accountRepository)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransferServiceImpl</span>(accountRepository);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析机制与基于构造函数的依赖注入基本相同。</p>
<h5 id="接收生命周期的回调"><a href="#接收生命周期的回调" class="headerlink" title="接收生命周期的回调"></a>接收生命周期的回调</h5><p>任何用 <code>@Bean</code> 注解定义的类都支持常规的生命周期回调。<code>@Bean</code> 注解支持指定任意的初始化和销毁回调方法，就像 <code>Spring XML</code> 在 <code>bean</code> 元素上的 <code>init-method</code> 和 <code>destroy-method</code> 属性一样，如下例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanOne</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// initialization logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanTwo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// destruction logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;init&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BeanOne <span class="title function_">beanOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanOne</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(destroyMethod = &quot;cleanup&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BeanTwo <span class="title function_">beanTwo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanTwo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认情况下，用 <code>Java</code> 配置定义的具有 <code>public</code> 的 <code>close</code> 或 <code>shutdown</code> 方法的Bean会自动被列入销毁回调。如果你有一个 <code>public</code> 的 <code>close</code> 或 <code>shutdown</code> 方法，并且你不希望它在容器关闭时被调用，你可以在你的 <code>bean</code> 定义中添加 <code>@Bean(destroyMethod = &quot;&quot;)</code> 来禁用默认 <code>(inferred)</code> 模式。</p>
</blockquote>
<p>就前文例子中的 <code>BeanOne</code> 而言，在构造过程中直接调用 <code>init()</code> 方法同样有效，正如下面的例子所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BeanOne <span class="title function_">beanOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">BeanOne</span> <span class="variable">beanOne</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanOne</span>();</span><br><span class="line">        beanOne.init();</span><br><span class="line">        <span class="keyword">return</span> beanOne;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="指定-Bean-的-Scope"><a href="#指定-Bean-的-Scope" class="headerlink" title="指定 Bean 的 Scope"></a>指定 Bean 的 Scope</h5><p>Spring包括 <code>@Scope</code> 注解，这样你就可以指定Bean的 scope。</p>
<h6 id="使用-Scope-注解"><a href="#使用-Scope-注解" class="headerlink" title="使用 @Scope 注解"></a>使用 <code>@Scope</code> 注解</h6><p>你可以指定你用 <code>@Bean</code> 注解定义的 <code>bean</code> 应该有一个特定的 <code>scope</code>。你可以指定任何一个标准 <code>scope</code>。</p>
<p>默认的 <code>scope</code> 是 <code>singleton</code>，但你可以用 <code>@Scope</code> 注解来覆盖它，如下例所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Encryptor <span class="title function_">encryptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="自定义Bean的命名"><a href="#自定义Bean的命名" class="headerlink" title="自定义Bean的命名"></a>自定义Bean的命名</h5><p>默认情况下，配置类使用 <code>@Bean</code> 方法的名称作为结果Bean的名称。然而，这个功能可以通过 <code>name</code> 属性来重写，正如下面的例子所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;myThing&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Thing <span class="title function_">thing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thing</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Bean-别名"><a href="#Bean-别名" class="headerlink" title="Bean 别名"></a>Bean 别名</h5><p><code>@Bean</code> 注解的 <code>name</code> 属性接受一个 <code>String</code> 数组来实现这一目的。下面的例子展示了如何为一个 <code>bean</code> 设置若干别名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&#123;&quot;dataSource&quot;, &quot;subsystemA-dataSource&quot;, &quot;subsystemB-dataSource&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// instantiate, configure and return DataSource bean...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Bean-描述（Description）"><a href="#Bean-描述（Description）" class="headerlink" title="Bean 描述（Description）"></a>Bean 描述（Description）</h5><p>有时，为 <code>bean</code> 提供更详细的文本描述是有帮助的。为了给 <code>@Bean</code> 添加描述，你可以使用 <code>@Description</code> 注解，如下图所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Description(&quot;Provides a basic example of a bean&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Thing <span class="title function_">thing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thing</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-Configuration注解"><a href="#使用-Configuration注解" class="headerlink" title="使用@Configuration注解"></a>使用@Configuration注解</h4><p><code>@Configuration</code> 是一个类级注解，表示一个对象是Bean定义的来源。<code>@Configuration</code> 类通过 <code>@Bean</code> 注解的方法声明bean。对 <code>@Configuration</code> 类上的 <code>@Bean</code> 方法的调用也可以用来定义bean间的依赖关系。</p>
<h5 id="注入bean间的依赖"><a href="#注入bean间的依赖" class="headerlink" title="注入bean间的依赖"></a>注入bean间的依赖</h5><p>当Bean相互之间有依赖关系时，表达这种依赖关系就像让一个 <code>bean</code> 方法调用另一个一样简单，正如下面的例子所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BeanOne <span class="title function_">beanOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanOne</span>(beanTwo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BeanTwo <span class="title function_">beanTwo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanTwo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-ComponentScan"><a href="#使用-ComponentScan" class="headerlink" title="使用@ComponentScan"></a>使用@ComponentScan</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;org.example&quot;, //扫描的包</span></span><br><span class="line"><span class="meta">        includeFilters = @Filter(type = FilterType.REGEX, pattern = &quot;.*Stub.*Repository&quot;),</span></span><br><span class="line"><span class="meta">        excludeFilters = @Filter(Repository.class))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的列表显示了等效的XML。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.example&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;regex&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">expression</span>=<span class="string">&quot;.*Stub.*Repository&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">expression</span>=<span class="string">&quot;org.Springframework.stereotype.Repository&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h1><p>代理模式术语：</p>
<ul>
<li>代理类：包装目标类的类</li>
<li>目标类：被包装的类</li>
</ul>
<p>通过代理类包装目标类，代理类对客户端完全透明。客户端访问代理类，代理类再访问目标类，外界无法访问目标类。</p>
<p><code>GoF</code> 23种设计模式之一的代理模式可用来进行一些功能操作：</p>
<ul>
<li>实现代码增强。目标对象只需要关注业务代码，额外的操作可以在代理对象中实现。</li>
<li>提高安全性。在完全进入目标对象前，由代理对象进行一系列的安全判断，以防安全问题或错误出现。</li>
</ul>
<p>在 <code>java</code> 中代理可分为静态代理和动态代理。代理必须通过接口完成。</p>
<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>现在有一个接口 <code>OrderService</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看订单详情</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">detail</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">modify</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是它的实现类 <code>OrderServiceImpl</code> 也就是目标类，用于订单的一些操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;订单已生成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detail</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;订单信息如下：******&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modify</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;订单已修改&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下就为目标类的代理类 <code>OrderServiceProxy</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span>&#123; <span class="comment">// 代理对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标对象</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过构造方法将目标对象传递给代理对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderServiceProxy</span><span class="params">(OrderService orderService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderService = orderService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算开始时间</span></span><br><span class="line">        <span class="comment">// 执行目标对象的目标方法</span></span><br><span class="line">        orderService.generate();</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算结束时间</span></span><br><span class="line">        System.out.println(<span class="string">&quot;耗时&quot;</span>+(end - begin)+<span class="string">&quot;毫秒&quot;</span>); <span class="comment">//打印结束时间</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算开始时间</span></span><br><span class="line">        <span class="comment">// 执行目标对象的目标方法</span></span><br><span class="line">        orderService.detail();</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算结束时间</span></span><br><span class="line">        System.out.println(<span class="string">&quot;耗时&quot;</span>+(end - begin)+<span class="string">&quot;毫秒&quot;</span>); <span class="comment">//打印结束时间</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算开始时间</span></span><br><span class="line">        <span class="comment">// 执行目标对象的目标方法</span></span><br><span class="line">        orderService.modify();</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算结束时间</span></span><br><span class="line">        System.out.println(<span class="string">&quot;耗时&quot;</span>+(end - begin)+<span class="string">&quot;毫秒&quot;</span>); <span class="comment">//打印结束时间</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>可见代理类对目标类进行了一些功能增强，且使用了对象组合，大大降低了耦合度。</p>
<p>客户端通过访问该代理类，就可以访问目标类的功能，且能使用额外的功能</p>
</blockquote>
<p>以上就是代理模式中的静态代理，其中 <code>OrderService</code> 接口是代理类和目标类的共同接口。<code>OrderServiceImpl</code> 是目标类。<code>OrderServiceProxy</code> 是代理类。</p>
<p>静态代理的缺点：</p>
<ul>
<li>如果系统中业务接口很多，一个接口对应一个代理类，会导致类爆炸</li>
<li>增强代码荣誉无法复用</li>
</ul>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>动态代理通过使用反射来解决静态代理的缺点。下面我们来介绍动态代理。</p>
<p><code>JDK</code> 中的 <code>java.lang.reflect</code> 中的 <code>Proxy</code> 专门用来处理动态代理。<code>Proxy</code> 类使用静态方法 <code>newInstance()</code> 来动态创建代理对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> Proxy.newInstance(类加载器，接口，调用处理器) <span class="comment">//返回代理对象，可通过接口强转至目标接口的对象</span></span><br><span class="line"><span class="comment">/*类加载器：	 ClassLoader，动态创建代理类字节码后，需要用类加载器加载进JVM内存。</span></span><br><span class="line"><span class="comment">    		代理类和目标类的类加载器必须相同，也就是应用类加载器。通过ClassLoader.getSystemClassLoader()获取默认的应用类加载器 */</span></span><br><span class="line"><span class="comment">//接口：Class，目标类的接口的字节码对象。</span></span><br><span class="line"><span class="comment">//调用处理器：InvocationHandler。用于真正调用目标对象。</span></span><br></pre></td></tr></table></figure>

<p>我们仍然使用 <code>OrderService</code> 和 <code>OrderServiceImpl</code> 来举例子。下面我们来看 <code>InvocationHandler</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	InvocationHandler只有一个方法也就是invoke，我们来分析这个方法的参数。</span></span><br><span class="line"><span class="comment">	proxy：通过Proxy.newInstance()创建的代理对象。</span></span><br><span class="line"><span class="comment">	method：被调用的方法对象，通过method调用真正的目标方法。</span></span><br><span class="line"><span class="comment">	args：方法所用的参数数组。</span></span><br><span class="line"><span class="comment">	-------------------------------------------------------------</span></span><br><span class="line"><span class="comment">	在调用目标方法前后即可使用增强代码</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>让我们来实现 <code>InvocationHandler</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService; <span class="comment">//获得目标对象，以用来调用目标对象的目标方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderInvocationHandler</span><span class="params">(OrderService orderService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orderService = orderService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算开始时间</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行目标对象的目标方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">res</span> <span class="operator">=</span> method.invoke(orderService, args); </span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">//计算结束时间</span></span><br><span class="line">        System.out.println(<span class="string">&quot;耗时&quot;</span>+(end - begin)+<span class="string">&quot;毫秒&quot;</span>); <span class="comment">//打印结束时间</span></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成上述准备工作后，我们来创建代理对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">OrderService</span> <span class="variable">orderService</span> <span class="operator">=</span> (OrderService) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), OrderServiceImpl.class.getInterfaces(), <span class="keyword">new</span> <span class="title class_">OrderInvocationHandler</span>(<span class="keyword">new</span> <span class="title class_">OrderServiceImpl</span>()));</span><br><span class="line">    <span class="comment">//调用代理对象的方法</span></span><br><span class="line">    orderService.generate();</span><br><span class="line">    orderService.detail();</span><br><span class="line">    orderService.modify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">订单已生成</span><br><span class="line">耗时1毫秒</span><br><span class="line">订单信息如下：******</span><br><span class="line">耗时0毫秒</span><br><span class="line">订单已修改</span><br><span class="line">耗时0毫秒</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可见动态代理解决了静态代理的类爆炸和代码冗余问题</p>
</blockquote>
<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>下面我们来修改一下 <code>main</code> 方法的一些细节：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    System.getProperties().put(<span class="string">&quot;jdk.proxy.ProxyGenerator.saveGeneratedFiles&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    <span class="type">OrderService</span> <span class="variable">orderService</span> <span class="operator">=</span> (OrderService) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), OrderServiceImpl.class.getInterfaces(), <span class="keyword">new</span> <span class="title class_">OrderInvocationHandler</span>(<span class="keyword">new</span> <span class="title class_">OrderServiceImpl</span>()));</span><br><span class="line">    <span class="comment">//调用代理对象的方法</span></span><br><span class="line">    orderService.generate();</span><br><span class="line">    orderService.detail();</span><br><span class="line">    orderService.modify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不出意外你将会在目录中看到 <code>jdk.proxy1.$proxy0</code> 的字节码文件，该文件即之前创造的代理对象。下面我们来看看这对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">$Proxy0</span> <span class="keyword">extends</span> <span class="title class_">Proxy</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123; <span class="comment">/*</span></span><br><span class="line"><span class="comment">																	该类实现了OrderService，所以该对象可以强转为目标接口对象</span></span><br><span class="line"><span class="comment">																	且继承了Proxy，由于单继承，所有JDK的动态代理无法使用继承实现</span></span><br><span class="line"><span class="comment">																	*/</span></span><br><span class="line">    <span class="comment">//代理类的所有属性均为Method常量。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method m0;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method m4;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method m5;</span><br><span class="line">    <span class="comment">// 代理类的构造方法，以InvocationHandler为参数</span></span><br><span class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) &#123;</span><br><span class="line">        <span class="built_in">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对代理对象的方法调用，最终都会转换成对InvocationHandler对象的invoke方法的调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m0, (Object[])<span class="literal">null</span>);</span><br><span class="line">		......</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//对代理对象的方法调用，最终都会转换成对InvocationHandler对象的invoke方法的调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object var1)</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m1, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;var1&#125;);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//对代理对象的方法调用，最终都会转换成对InvocationHandler对象的invoke方法的调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m2, (Object[])<span class="literal">null</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//对代理对象的方法调用，最终都会转换成对InvocationHandler对象的invoke方法的调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">       ......</span><br><span class="line">            <span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m3, (Object[])<span class="literal">null</span>);</span><br><span class="line">       ......</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//对代理对象的方法调用，最终都会转换成对InvocationHandler对象的invoke方法的调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">detail</span><span class="params">()</span> &#123;</span><br><span class="line">      ......</span><br><span class="line">            <span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m4, (Object[])<span class="literal">null</span>);</span><br><span class="line">       ......</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//对代理对象的方法调用，最终都会转换成对InvocationHandler对象的invoke方法的调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">modify</span><span class="params">()</span> &#123;</span><br><span class="line">       ......</span><br><span class="line">            <span class="built_in">super</span>.h.invoke(<span class="built_in">this</span>, m5, (Object[])<span class="literal">null</span>);</span><br><span class="line">       ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//代理类会获得Object的hashCode方法，equals方法、toString方法以及目标接口的所有方法的Method对象，然后重写他们</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">            m0 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">            m1 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;equals&quot;</span>, Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>));</span><br><span class="line">            m2 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="string">&quot;toString&quot;</span>);</span><br><span class="line">            m3 = Class.forName(<span class="string">&quot;com.jhy.proxy.OrderService&quot;</span>).getMethod(<span class="string">&quot;generate&quot;</span>);</span><br><span class="line">            m4 = Class.forName(<span class="string">&quot;com.jhy.proxy.OrderService&quot;</span>).getMethod(<span class="string">&quot;detail&quot;</span>);</span><br><span class="line">            m5 = Class.forName(<span class="string">&quot;com.jhy.proxy.OrderService&quot;</span>).getMethod(<span class="string">&quot;modify&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>JDK</code> 会在运行中动态创建名为 <code>$Proxy</code> + 数字的代理类，并且让这个类继承 <code>Proxy</code> 类并且实现目标接口</p>
</blockquote>
<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p><code>IoC</code> 使软件组件松耦合。<code>AOP</code> 让你能够捕捉系统中经常使用的功能，把它转化成组件。</p>
<p><code>AOP（Aspect Oriented Programming）</code>：面向切面编程，面向方面编程。（<code>AOP</code> 是一种编程技术）</p>
<p><code>AOP</code> 是对 <code>OOP</code> 的补充延伸。<code>AOP</code> 底层使用的就是动态代理来实现的。</p>
<p><code>Spring</code> 的 <code>AOP</code> 使用的动态代理是：<code>JDK</code> 动态代理 + <code>CGLIB</code> 动态代理技术。<code>Spring</code> 在这两种动态代理中灵活切换，如果是代理接口，会默认使用 <code>JDK</code> 动态代理，如果要代理某个类，这个类没有实现接口，就会切换使用 <code>CGLIB</code> 。当然，你也可以强制通过一些配置让 <code>Spring</code> 只使用 <code>CGLIB</code>。</p>
<h2 id="AOP介绍"><a href="#AOP介绍" class="headerlink" title="AOP介绍"></a>AOP介绍</h2><p>一般一个系统当中都会有一些系统服务，例如：日志、事务管理、安全等。这些系统服务被称为：<strong>交叉业务</strong></p>
<p>这些<strong>交叉业务</strong>几乎是通用的，不管你是做银行账户转账，还是删除用户数据。日志、事务管理、安全，这些都是需要做的。</p>
<p>如果在每一个业务处理过程当中，都掺杂这些交叉业务代码进去的话，存在两方面问题：</p>
<ul>
<li>第一：交叉业务代码在多个业务流程中反复出现，显然这个交叉业务代码没有得到复用。并且修改这些交叉业务代码的话，需要修改多处。</li>
<li>第二：程序员无法专注核心业务代码的编写，在编写核心业务代码的同时还需要处理这些交叉业务。</li>
</ul>
<p>使用 <code>AOP</code> 可以很轻松的解决以上问题。</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="aop.png" alt="AOP图解">

<h2 id="AOP八大术语"><a href="#AOP八大术语" class="headerlink" title="AOP八大术语"></a>AOP八大术语</h2><p>让我们首先定义一些核心的AOP概念和术语。这些术语并不是针对 <code>Spring</code> 的。</p>
<ul>
<li><code>Aspect</code>（切面）: 一个跨越多个类的关注点的模块化。事务管理是企业级Java应用中横切关注点的一个很好的例子。在 <code>Spring AOP</code> 中，切面是通过使用常规类（基于 <code>XML</code> ）或使用 <code>@Aspect</code> 注解的常规类（ <code>@AspectJ</code> 风格）实现的。</li>
<li><code>Join point</code>（连接点）: 程序执行过程中的一个点，例如一个方法的执行或一个异常的处理。在 <code>Spring AOP</code> 中，一个连接点总是代表一个方法的执行。</li>
<li><code>Advice</code>（通知）: 一个切面在一个特定的连接点采取的行动。不同类型的advice包括 “around”、”before” 和 “after” 的advice（Advice 类型将在后面讨论）。许多AOP框架，包括Spring，都将advice建模为一个拦截器，并在连接点（Join point）周围维护一个拦截器链。</li>
<li><code>Pointcut</code>（切点）: 一个匹配连接点的谓词（predicate）。<code>advice</code> 与一个切点表达式相关联，并在切点匹配的任何连接点上运行（例如，执行一个具有特定名称的方法）。由切点表达式匹配的连接点概念是 <code>AOP</code> 的核心，Spring默认使用AspectJ的切点表达式语言。</li>
<li><code>Introduction</code>（引入）: 代表一个类型声明额外的方法或字段。Spring AOP允许你为任何 advice 的对象引入新的接口（以及相应的实现）。例如，你可以使用引入来使一个bean实现 <code>IsModified</code> 接口，以简化缓存。（介绍在AspectJ社区中被称为类型间声明）。</li>
<li><code>Target object</code>（目标对象）: 被一个或多个切面所 advice 的对象。也被称为 “advised object”。由于Spring AOP是通过使用运行时代理来实现的，这个对象总是一个被代理的对象。</li>
<li><code>AOP proxy</code>（代理对象）: 一个由 <code>AOP</code> 框架创建的对象，以实现切面契约（<code>advice</code> 方法执行等）。在 <code>Spring</code> 框架中，<code>AOP</code>代理是一个 <code>JDK</code> 动态代理或 <code>CGLIB</code> 代理。</li>
<li><code>Weaving</code>（织入）: 将 <code>aspect</code> 与其他应用程序类型或对象连接起来，以创建一个 <code>advice</code> 对象。这可以在编译时（例如，使用 <code>AspectJ</code> 编译器）、加载时或运行时完成。<code>Spring AOP</code> 和其他纯 <code>Java AOP</code> 框架一样，在运行时进行织入。</li>
</ul>
<p><code>Spring AOP</code> 包括以下类型的 <code>advice</code>。</p>
<ul>
<li><code>Before advice</code>: 在连接点之前运行的Advice ，但它不具备以下能力 阻止执行流进行到 join point 的能力（除非它抛出一个异常）。</li>
<li><code>After returning advice</code>: 在一个连接点正常完成后运行的Advice （例如，如果一个方法返回时没有抛出一个异常）。</li>
<li><code>After (finally) advice</code>: 无论连接点以何种方式退出（正常或特殊返回），都要运行该advice。</li>
<li><code>Around advice</code>: 围绕一个连接点的advice，如方法调用。这是最强大的一种advice。Around advice可以在方法调用之前和之后执行自定义行为。它还负责选择是否继续进行连接点或通过返回自己的返回值或抛出一个异常来缩短advice方法的执行。</li>
</ul>
<h2 id="使用Spring的AOP"><a href="#使用Spring的AOP" class="headerlink" title="使用Spring的AOP"></a>使用Spring的AOP</h2><p>Spring对AOP的实现包括以下3种方式：</p>
<ul>
<li><strong>第一种方式：Spring框架结合AspectJ框架实现的AOP，基于注解方式。</strong></li>
<li><strong>第二种方式：Spring框架结合AspectJ框架实现的AOP，基于XML方式。</strong></li>
<li>第三种方式：Spring框架自己实现的AOP，基于XML配置方式。</li>
</ul>
<p>使用 <code>AOP</code> 必须含有以下注解：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="注解-1"><a href="#注解-1" class="headerlink" title="注解"></a>注解</h3><p>使用注解的方式，必须要是有 <code>@Aspecj</code> 注解标注切面类。</p>
<h4 id="开启-AspectJ的支持"><a href="#开启-AspectJ的支持" class="headerlink" title="开启@AspectJ的支持"></a>开启@AspectJ的支持</h4><h5 id="通过-XML-开启"><a href="#通过-XML-开启" class="headerlink" title="通过 XML 开启"></a>通过 <code>XML</code> 开启</h5><p>使用 <code>aop</code> 命名空间开启开启 <code>@AspectJ</code> 的支持</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	保证下面的约束存在</span></span><br><span class="line"><span class="comment">	xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="line"><span class="comment">	xsi:schemaLocation=&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	配置启用 @AspectJ 支持，当然如果你想约束aop的底层代理实现你也可以使用proxy-target-class属性</span></span><br><span class="line"><span class="comment">	proxy-target-class默认为false，代表使用cglib动态代理或jdk的动态代理</span></span><br><span class="line"><span class="comment">	将proxy-target-class设置为true，则代表强制使用cglib动态代理</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="通过注解开启"><a href="#通过注解开启" class="headerlink" title="通过注解开启"></a>通过注解开启</h5><p>在自定以的配置类中使用注解 <code>@EnableAspectJAutoProxy</code> 开启 <code>@AspectJ</code> 的支持：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfiguration</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="声明一个-Aspect类"><a href="#声明一个-Aspect类" class="headerlink" title="声明一个 Aspect类"></a>声明一个 Aspect类</h4><p>启用 <code>@AspectJ</code> 支持后，任何在你的 <code>application context</code> 中定义的 <code>bean</code> ，其类是 <code>@AspectJ</code> 切面（有 <code>@Aspect</code> 注解），会被 <code>Spring</code> 自动检测到，并用于配置<code>Spring AOP</code> 。接下来的两个例子展示了一个不怎么有用的切面所需的最小步骤。</p>
<p>两个例子中的第一个显示了 <code>application context</code> 中的一个普通 <code>Bean</code> 定义，它指向一个用 <code>@Aspect</code> 注解的 <code>Bean</code> 类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myAspect&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.xyz.NotVeryUsefulAspect&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- configure properties of the aspect here --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>两个例子中的第二个展示了 <code>NotVeryUsefulAspect</code> 类的定义，它被 <code>@Aspect</code> 注解了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotVeryUsefulAspect</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="声明一个切点（Pointcut）"><a href="#声明一个切点（Pointcut）" class="headerlink" title="声明一个切点（Pointcut）"></a>声明一个切点（Pointcut）</h4><p><code>Pointcuts</code> 确定感兴趣的连接点（<code>join points</code>），从而使我们能够控制 <code>advice</code> 的运行时间。<code>Spring AOP</code> 只支持 <code>Spring Bean</code> 的方法执行连接点，所以你可以把<code>pointcut</code> 看作是对 <code>Spring Bean</code> 上的方法执行的匹配。一个切点声明有两个部分：一个由名称和任何参数组成的签名，以及一个切点表达式，它决定了我们到底对哪些方法的执行感兴趣。在 <code>AOP</code> 的 <code>@AspectJ</code> 注解式中，一个 <code>pointcut</code> 签名是由一个常规的方法定义提供的，而 <code>pointcut</code> 表达式是通过使用 <code>@Pointcut</code> 注解来表示的（作为<code>pointcut</code> 签名的方法必须是一个 <code>void</code> 返回类型）。</p>
<p>一个例子可以帮助我们清楚地了解切点签名和切点表达式之间的区别。下面的例子定义了一个名为 <code>anyOldTransfer</code> 的切点，它匹配任何名为 <code>transfer</code> 的方法的执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(* transfer(..))&quot;)</span> <span class="comment">// the pointcut expression</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">anyOldTransfer</span><span class="params">()</span> &#123;&#125; <span class="comment">// the pointcut signature</span></span><br></pre></td></tr></table></figure>

<h5 id="支持的-Pointcut-指定器"><a href="#支持的-Pointcut-指定器" class="headerlink" title="支持的 Pointcut 指定器"></a>支持的 <code>Pointcut</code> 指定器</h5><p><code>Spring AOP</code> 支持以下 <code>AspectJ</code> 的切点指定器（ <code>PCD</code> ），用于切点表达式中。</p>
<ul>
<li><code>execution</code>: 用于匹配方法执行的连接点。这是在使用 <code>Spring AOP</code> 时要使用的主要切点指定器。</li>
<li><code>within</code>: 将匹配限制在某些类型内的连接点（使用 <code>Spring AOP</code> 时，执行在匹配类型内声明的方法）。</li>
<li><code>this</code>: 将匹配限制在连接点（使用 <code>Spring AOP</code> 时方法的执行），其中 <code>bean</code> 引用（ <code>Spring AOP</code> 代理）是给定类型的实例。</li>
<li><code>target</code>: 将匹配限制在连接点（使用 <code>Spring AOP</code> 时方法的执行），其中目标对象（被代理的应用程序对象）是给定类型的实例。</li>
<li><code>args</code>: 将匹配限制在连接点（使用 <code>Spring AOP</code> 时方法的执行），其中参数是给定类型的实例。</li>
<li><code>@target</code>: 限制匹配到连接点（使用 <code>Spring AOP</code> 时方法的执行），其中执行对象的类有一个给定类型的注解。</li>
<li><code>@args</code>: 将匹配限制在连接点（使用 <code>Spring AOP</code> 时方法的执行），其中实际传递的参数的运行时类型有给定类型的注解。</li>
<li><code>@within</code>: 将匹配限制在具有给定注解的类型中的连接点（使用 <code>Spring AOP</code> 时，执行在具有给定注解的类型中声明的方法）。</li>
<li><code>@annotation</code>: 将匹配限制在连接点的主体（ <code>Spring AOP</code> 中正在运行的方法）具有给定注解的连接点上。</li>
</ul>
<p>切点表达式用来定义通知（ <code>Advice</code> ）往哪些方法上切入。</p>
<h6 id="切点表达式"><a href="#切点表达式" class="headerlink" title="切点表达式"></a>切点表达式</h6><p>切入点表达式语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution([访问控制权限修饰符] 返回值类型 [全限定类名]方法名(形式参数列表) [异常])</span><br></pre></td></tr></table></figure>

<p>访问控制权限修饰符：</p>
<ul>
<li>可选项。</li>
<li>没写，就是4个权限都包括。</li>
<li>写public就表示只包括公开的方法。</li>
</ul>
<p>返回值类型：</p>
<ul>
<li>必填项。</li>
<li>* 表示返回值类型任意。</li>
</ul>
<p>全限定类名：</p>
<ul>
<li>可选项。</li>
<li>两个点“..”代表当前包以及子包下的所有类。</li>
<li>省略时表示所有的类。</li>
</ul>
<p>方法名：</p>
<ul>
<li>必填项。</li>
<li>*表示所有方法。</li>
<li>set*表示所有的set方法。</li>
</ul>
<p>形式参数列表：</p>
<ul>
<li><p>必填项</p>
</li>
<li><p>() 表示没有参数的方法</p>
</li>
<li><p>(..) 参数类型和个数随意的方法</p>
</li>
<li><p>(*) 只有一个参数的方法</p>
</li>
<li><p>(*, String) 第一个参数类型随意，第二个参数是String的。</p>
</li>
</ul>
<p>异常：</p>
<ul>
<li>可选项。</li>
<li>省略时表示任意异常类型。</li>
</ul>
<h6 id="组合切点（Pointcut）表达式"><a href="#组合切点（Pointcut）表达式" class="headerlink" title="组合切点（Pointcut）表达式"></a>组合切点（Pointcut）表达式</h6><p>你可以通过使用 <code>&amp;&amp;</code>、<code>||</code> 和 <code>!</code> 来组合 <code>pointcut</code> 表达式。你也可以通过名称来引用 <code>pointcut</code> 表达式。下面的例子显示了三个 <code>pointcut</code> 表达式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pointcuts</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(public * *(..))&quot;)</span> <span class="comment">//1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publicMethod</span><span class="params">()</span> &#123;&#125; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;within(com.xyz.trading..*)&quot;)</span> <span class="comment">//2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inTrading</span><span class="params">()</span> &#123;&#125; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;publicMethod() &amp;&amp; inTrading()&quot;)</span> <span class="comment">//3</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tradingOperation</span><span class="params">()</span> &#123;&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果一个方法执行连接点代表任何 <code>public</code> 方法的执行，则 <code>publicMethod</code> 匹配。</li>
<li><code>inTrading</code> 匹配一个方法的执行是否在 <code>trading</code> 模块中。</li>
<li>如果一个方法的执行代表了 <code>trading</code> 模块中的任何 <code>public</code> 方法，则 <code>tradingOperation</code> 匹配</li>
</ol>
<p>如上所示，从较小的命名的切点程序中建立更复杂的切点程序表达式是一种最佳做法。当通过名称来引用点切时，正常的 <code>Java</code> 可见性规则适用（你可以看到同一类型中的 <code>private</code> 切点、层次结构中的 <code>protected</code> 切点、任何地方的 <code>public</code> 切点，等等）。可见性并不影响切点的匹配。</p>
<h4 id="声明-Advice"><a href="#声明-Advice" class="headerlink" title="声明 Advice"></a>声明 Advice</h4><p><code>Advice</code> 与一个切点表达式相关联，在切点匹配的方法执行之前、之后或周围（around）运行。切点表达式可以是一个内联切点，也可以是对一个 <a target="_blank" rel="noopener" href="https://springdoc.cn/spring/core.html#aop-common-pointcuts">命名切点</a> 的引用</p>
<h5 id="Before-Advice"><a href="#Before-Advice" class="headerlink" title="Before Advice"></a>Before Advice</h5><p>你可以通过使用 <code>@Before</code> 注解在一个切面中声明 <code>before advice</code>。</p>
<p>下面的例子使用了一个内联的切点表达式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeforeExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.xyz.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAccessCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们使用一个 <a target="_blank" rel="noopener" href="https://springdoc.cn/spring/core.html#aop-common-pointcuts">命名的切点</a>，我们可以把前面的例子改写成如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeforeExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;com.xyz.CommonPointcuts.dataAccessOperation()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAccessCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="After-Returning-Advice"><a href="#After-Returning-Advice" class="headerlink" title="After Returning Advice"></a>After Returning Advice</h5><p>当一个匹配的方法执行正常返回时，<code>After returning advice</code> 运行。你可以通过使用 <code>@AfterReturning</code> 注解来声明它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterReturningExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;execution(* com.xyz.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAccessCheck</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>你可以有多个 advice 声明（也可以有其他成员），都在同一个切面。我们在这些例子中只展示了一个 advice 声明，以集中展示每个 advice 的效果。</p>
</blockquote>
<p>有时，你需要在 <code>advice body</code> 中访问被返回的实际值。你可以使用绑定返回值的 <code>@AfterReturning</code> 的形式来获得这种访问权，正如下面的例子所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterReturningExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(</span></span><br><span class="line"><span class="meta">        pointcut=&quot;execution(* com.xyz.dao.*.*(..))&quot;,</span></span><br><span class="line"><span class="meta">        returning=&quot;retVal&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAccessCheck</span><span class="params">(Object retVal)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>returning</code> 属性中使用的名称必须与advice方法中的参数名称相对应。当一个方法执行返回时，返回值会作为相应的参数值传递给 <code>advice</code> 方法。<code>returning</code> 子句也限制了匹配，只匹配那些返回指定类型的值的方法执行（在这种情况下是 <code>Object</code>，它匹配任何返回值）。</p>
<h5 id="After-Throwing-Advice"><a href="#After-Throwing-Advice" class="headerlink" title="After Throwing Advice"></a>After Throwing Advice</h5><p>当一个匹配的方法执行通过抛出异常退出时，<code>After throwing advice</code> 运行。你可以通过使用 <code>@AfterThrowing</code> 注解来声明它，如下例所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterThrowingExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;execution(* com.xyz.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRecoveryActions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常情况下，你希望 <code>advice</code> 只在给定类型的异常被抛出时运行，而且你也经常需要在 <code>advice body</code> 中访问被抛出的异常。你可以使用 <code>throwing</code> 属性来限制匹配（如果需要的话—否则使用 <code>Throwable</code> 作为异常类型），并将抛出的异常绑定到 <code>advice</code> 参数上。下面的例子展示了如何做到这一点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterThrowingExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(</span></span><br><span class="line"><span class="meta">        pointcut=&quot;execution(* com.xyz.dao.*.*(..))&quot;,</span></span><br><span class="line"><span class="meta">        throwing=&quot;ex&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRecoveryActions</span><span class="params">(DataAccessException ex)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>throwing</code> 属性中使用的名称必须与advice方法中的参数名称相对应。当一个方法的执行通过抛出一个异常退出时，该异常将作为相应的参数值传递给advice方法。<code>throwing</code> 子句也限制了匹配，只能匹配那些抛出指定类型的异常的方法执行（本例中是 <code>DataAccessException</code>）。</p>
<blockquote>
<p>注意，<code>@AfterThrowing</code> 并不表示一般的异常处理回调。具体来说，<code>@AfterThrowing advice</code> 方法只应该接收来自连接点（用户声明的目标方法）本身的异常，而不是来自附带的 <code>@After</code>&#x2F;<code>@AfterReturning</code> 方法。</p>
</blockquote>
<h5 id="After-Finally-Advice"><a href="#After-Finally-Advice" class="headerlink" title="After (Finally) Advice"></a>After (Finally) Advice</h5><p>当一个匹配的方法执行退出时，After (finally) advice 会运行。它是通过使用 <code>@After</code> 注解来声明的。After advice必须准备好处理正常和异常的返回条件。它通常被用于释放资源和类似的目的。下面的例子展示了如何使用 After finally advice。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AfterFinallyExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.xyz.dao.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doReleaseLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请注意，<code>AspectJ</code> 中的 <code>@After</code> <code>advice</code> 被定义为 “after finally advice”，类似于 <code>try-catch</code> 语句中的 <code>finally</code> 块。它将对任何结果、正常返回或从连接点（用户声明的目标方法）抛出的异常进行调用，这与 <code>@AfterReturning</code> 不同，后者只适用于成功的正常返回。</p>
</blockquote>
<h5 id="Around-Advice"><a href="#Around-Advice" class="headerlink" title="Around Advice"></a>Around Advice</h5><p>最后一种 <code>Advice</code> 是 <code>Around Advice</code>。 “围绕” 一个匹配的方法的执行而运行。它有机会在方法运行之前和之后进行工作，并决定何时、如何、甚至是否真正运行该方法。如果你需要以线程安全的方式分享方法执行前后的状态，例如启动和停止一个定时器，那么 <code>Around advice</code> 经常被使用。</p>
<blockquote>
<p>始终使用符合你要求的最不强大的 <code>advice</code> 形式。例如，如果 <code>before advice</code> 足以满足你的需要，就不要使用 <code>around advice</code>。</p>
</blockquote>
<p><code>Around advice</code> 是通过用 <code>@Around</code> 注解来声明一个方法的。该方法应该声明 <code>Object</code> 为其返回类型，并且该方法的第一个参数必须是 <code>ProceedingJoinPoint</code> 类型。在 advice 方法的body中，你必须在 <code>ProceedingJoinPoint</code> 上调用 <code>proceed()</code>，以使底层方法运行。在没有参数的情况下调用 <code>proceed()</code> 将导致调用者的原始参数在底层方法被调用时被提供给它。对于高级用例，有一个重载的 <code>proceed()</code> 方法，它接受一个参数数组（<code>Object[]</code>）。当底层方法被调用时，数组中的值将被用作该方法的参数。</p>
<p><code>around advice</code> 返回的值是方法的调用者看到的返回值。例如，一个简单的缓存切面可以从缓存中返回一个值（如果有的话），或者调用 <code>proceed()</code> （并返回该值），如果没有的话。请注意， <code>proceed</code> 可以被调用一次，多次，或者根本就不在 <code>around advice</code> 的 <code>body</code> 中调用。所有这些都是合法的。</p>
<blockquote>
<p>如果你将 <code>around advice</code> 方法的返回类型声明为 <code>void</code>，那么将总是返回给调用者 <code>null</code>，有效地忽略了任何调用 <code>proceed()</code> 的结果。因此，我们建议 <code>around advice</code> 方法声明一个 <code>Object</code> 的返回类型。该 <code>advice</code> 方法通常应该返回调用 <code>proceed()</code> 所返回的值，即使底层方法的返回类型为 <code>void</code>。然而，<code>advice</code> 可以根据使用情况选择性地返回一个缓存的值、一个封装的值或一些其他的值。</p>
</blockquote>
<p>下面的例子显示了如何使用 <code>around advice</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AroundExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.xyz..service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doBasicProfiling</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// start stopwatch</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">retVal</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        <span class="comment">// stop stopwatch</span></span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Advice-参数"><a href="#Advice-参数" class="headerlink" title="Advice 参数"></a>Advice 参数</h5><p><code>Spring</code> 提供了完全类型化的 <code>advice</code> ，这意味着你可以在 <code>advice</code> 签名中声明你需要的参数（就像我们在前面看到的返回和抛出的例子一样），而不是一直用 <code>Object[]</code> 数组工作。我们将在本节后面看到如何使参数和其他上下文值对 <code>advice</code> 主体可用。首先，我们看一下如何编写通用 <code>advice</code> ，它可以找出 <code>advice</code> 当前所 <code>advice</code> 的方法。</p>
<h6 id="访问当前的-JoinPoint"><a href="#访问当前的-JoinPoint" class="headerlink" title="访问当前的 JoinPoint"></a>访问当前的 <code>JoinPoint</code></h6><p>任何 <code>advice method</code> 都可以声明一个 <code>org.aspectj.lang.JoinPoint</code> 类型的参数作为其第一个参数。请注意，<code>around advice</code> 方法需要声明一个 <code>ProceedingJoinPoint</code> 类型的第一个参数，它是 <code>JoinPoint</code> 的一个子类。</p>
<p><code>JoinPoint</code> 接口提供了许多有用的方法。</p>
<ul>
<li><code>getArgs()</code>: 返回方法的参数。</li>
<li><code>getThis()</code>: 返回代理对象。</li>
<li><code>getTarget()</code>: 返回目标对象。</li>
<li><code>getSignature()</code>: 返回正在被 <code>advice</code> 的方法的描述。</li>
<li><code>toString()</code>: 打印对所 <code>advice</code> 的方法的有用描述。</li>
</ul>
<h6 id="向-Advice-传递参数"><a href="#向-Advice-传递参数" class="headerlink" title="向 Advice 传递参数"></a>向 Advice 传递参数</h6><p>我们已经看到了如何绑定返回值或异常值（使用 <code>after returning</code> 和 <code>after throwing advice</code> ）。为了使参数值对 <code>advice body</code> 可用，你可以使用 <code>args</code> 的绑定形式。如果你在 <code>args</code> 表达式中使用参数名来代替类型名，那么当 <code>advice</code> 被调用时，相应参数的值将作为参数值被传递。一个例子可以让我们更清楚地了解这一点。假设你想 <code>advice</code> 执行以一个 <code>Account</code> 对象为第一参数的DAO操作，并且你需要在 <code>advice body</code> 中访问该 <code>account</code> 。你可以写如下内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;execution(* com.xyz.dao.*.*(..)) &amp;&amp; args(account,..)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateAccount</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pointcut</code> 表达式的 <code>args(account,..)</code> 部分有两个作用。首先，它将匹配限制在方法的执行上，即方法至少需要一个参数，并且传递给该参数的参数是一个 <code>Account</code> 的实例。其次，它使实际的 <code>Account</code> 对象通过 <code>account</code> 参数对 <code>advice</code> 可用。</p>
<p>另一种写法是声明一个pointcut，当它与一个连接点匹配时 “提供” <code>Account</code> 对象的值，然后从 advice 中引用命名的pointcut。这看起来就像这样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;execution(* com.xyz.dao.*.*(..)) &amp;&amp; args(account,..)&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">accountDataAccessOperation</span><span class="params">(Account account)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before(&quot;accountDataAccessOperation(account)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateAccount</span><span class="params">(Account account)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更多细节请参见AspectJ编程指南。</p>
<p>代理对象（<code>this</code>）、目标对象（<code>target</code>）和注解（<code>@within</code>、<code>@target</code>、<code>@annotation</code> 和 <code>@args</code>）都可以用类似的方式绑定。接下来的一组例子展示了如何匹配执行带有 <code>@Auditable</code> 注解的方法，并提取审计代码。</p>
<p>下面是 <code>@Auditable</code> 注解的定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Auditable &#123;</span><br><span class="line">    AuditCode <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面显示了与 <code>@Auditable</code> 方法的执行相匹配的 advice。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;com.xyz.Pointcuts.publicMethod() &amp;&amp; @annotation(auditable)&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">audit</span><span class="params">(Auditable auditable)</span> &#123;</span><br><span class="line">    <span class="type">AuditCode</span> <span class="variable">code</span> <span class="operator">=</span> auditable.value();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>引用 “<a target="_blank" rel="noopener" href="https://springdoc.cn/spring/core.html#aop-pointcuts-combining">组合切点（Pointcut）表达式</a>” 中定义的 <code>publicMethod</code> 命名的 <code>pointcut</code>。</p>
</blockquote>
<h6 id="Advice-参数和泛型"><a href="#Advice-参数和泛型" class="headerlink" title="Advice 参数和泛型"></a>Advice 参数和泛型</h6><p>Spring AOP可以处理类声明和方法参数中使用的泛型。假设你有一个像下面这样的泛型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Sample</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sampleGenericMethod</span><span class="params">(T param)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sampleGenericCollectionMethod</span><span class="params">(Collection&lt;T&gt; param)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以将方法类型的拦截限制在某些参数类型上，办法是将 advice 参数与你想拦截方法的参数类型联系起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;execution(* ..Sample+.sampleGenericMethod(*)) &amp;&amp; args(param)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeSampleMethod</span><span class="params">(MyType param)</span> &#123;</span><br><span class="line">    <span class="comment">// Advice implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方法对泛型集合不起作用。所以你不能像下面这样定义一个pointcut。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;execution(* ..Sample+.sampleGenericCollectionMethod(*)) &amp;&amp; args(param)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeSampleMethod</span><span class="params">(Collection&lt;MyType&gt; param)</span> &#123;</span><br><span class="line">    <span class="comment">// Advice implementation</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了实现这一点，我们必须检查集合中的每一个元素，这是不太合理的，因为我们也无法决定如何处理一般的 <code>null</code>。为了实现与此类似的东西，你必须将参数输入到 <code>Collection&lt;?&gt;</code> 中，并手动检查元素的类型。</p>
<h6 id="确定参数名称"><a href="#确定参数名称" class="headerlink" title="确定参数名称"></a>确定参数名称</h6><p><code>advice</code> 调用中的参数绑定依赖于将在切点表达式中使用的名称与 advice 和切点方法签名中声明的参数名称相匹配。</p>
<p><code>Spring AOP</code>使用以下 <code>ParameterNameDiscoverer</code> 实现来确定参数名称。每个 discoverers 将有机会发现参数名称，第一个成功的发现者获胜。如果没有一个注册的 discoverers 能确定参数名称，那么将抛出一个异常。</p>
<ul>
<li><p><code>AspectJAnnotationParameterNameDiscoverer</code></p>
<p>使用用户通过相应的advice或指向性注解中的 <code>argNames</code> 属性明确指定的参数名称。详见 <a target="_blank" rel="noopener" href="https://springdoc.cn/spring/core.html#aop-ataspectj-advice-params-names-explicit">明确的参数名称</a>。</p>
</li>
<li><p><code>KotlinReflectionParameterNameDiscoverer</code></p>
<p>使用 <code>Kotlin</code> 反射API来确定参数名称。只有在classpath上存在这种API时，才会使用这个discoverer。</p>
</li>
<li><p><code>StandardReflectionParameterNameDiscoverer</code></p>
<p>使用标准的 <code>java.lang.reflect.Parameter</code> API来确定参数名称。需要用 <code>javac</code> 的 <code>-parameters</code> 标志来编译代码。建议在Java 8+上采用这种方法。</p>
</li>
<li><p><code>LocalVariableTableParameterNameDiscoverer</code></p>
<p>分析advice类的字节码中可用的局部变量表，从debug信息中确定参数名称。需要用debug参数（至少是 <code>-g:vars</code>）编译代码。从Spring Framework 6.0开始被弃用，在 Spring Framework 6.1中被移除，以支持用 <code>-parameters</code> 编译代码。在GraalVM原生镜像中不支持。</p>
</li>
<li><p><code>AspectJAdviceParameterNameDiscoverer</code></p>
<p>从 <code>pointcut</code> 表达式、<code>returning</code>, 和 <code>throwing</code> 子句中推导出参数名称。关于所用算法的细节，请参见 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.8-SNAPSHOT/javadoc-api/org/springframework/aop/aspectj/AspectJAdviceParameterNameDiscoverer.html">javadoc</a>。</p>
</li>
</ul>
<h6 id="明确的参数名称"><a href="#明确的参数名称" class="headerlink" title="明确的参数名称"></a>明确的参数名称</h6><p><code>@AspectJ</code> advice 和 pointcut 注解有一个可选的 <code>argNames</code> 属性，你可以用它来指定被注解方法的参数名称。</p>
<blockquote>
<p>如果一个 @AspectJ 切面已经被AspectJ编译器（<code>ajc</code>）编译，即使没有debug信息，你也不需要添加 <code>argNames</code> 属性，因为编译器会保留需要的信息。同样地，如果一个 @AspectJ 切面已经用 <code>javac</code> 的 <code>-parameters</code> 标志进行了编译，你就不需要添加 <code>argNames</code> 属性，因为编译器会保留所需的信息。</p>
</blockquote>
<p>下面的例子显示了如何使用 <code>argNames</code> 属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(</span></span><br><span class="line"><span class="meta">    value = &quot;com.xyz.Pointcuts.publicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)&quot;, </span></span><br><span class="line"><span class="meta">    argNames = &quot;bean,auditable&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">audit</span><span class="params">(Object bean, Auditable auditable)</span> &#123;</span><br><span class="line">    <span class="type">AuditCode</span> <span class="variable">code</span> <span class="operator">=</span> auditable.value();</span><br><span class="line">    <span class="comment">// ... use code and bean</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>引用 “<a target="_blank" rel="noopener" href="https://springdoc.cn/spring/core.html#aop-pointcuts-combining">组合切点（Pointcut）表达式</a>” 中定义的 <code>publicMethod</code> 命名的pointcut。声明 <code>bean</code> 和 <code>auditable</code> 为参数名。</p>
</blockquote>
<p>如果第一个参数是 <code>JoinPoint</code>、<code>ProceedingJoinPoint</code> 或 <code>JoinPoint.StaticPart</code> 类型，你可以在 <code>argNames</code> 属性的值中省略参数的名称。例如，如果你修改前面的advice来接收连接点（join point）对象，<code>argNames</code> 属性不需要包括它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(</span></span><br><span class="line"><span class="meta">    value = &quot;com.xyz.Pointcuts.publicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)&quot;, </span></span><br><span class="line"><span class="meta">    argNames = &quot;bean,auditable&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">audit</span><span class="params">(JoinPoint jp, Object bean, Auditable auditable)</span> &#123;</span><br><span class="line">    <span class="type">AuditCode</span> <span class="variable">code</span> <span class="operator">=</span> auditable.value();</span><br><span class="line">    <span class="comment">// ... use code, bean, and jp</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>引用“<a target="_blank" rel="noopener" href="https://springdoc.cn/spring/core.html#aop-pointcuts-combining">组合切点（Pointcut）表达式</a>”中定义的 <code>publicMethod</code> 命名的pointcut。声明 <code>bean</code> 和 <code>auditable</code> 为参数名。</p>
</blockquote>
<p>给予 <code>JoinPoint</code>、<code>ProceedingJoinPoint</code> 或 <code>JoinPoint.StaticPart</code> 类型的第一个参数的特殊处理，对于不收集任何其他连接点上下文的advice方法特别方便。在这种情况下，你可以省略 <code>argNames</code> 属性。例如，下面的advice不需要声明 <code>argNames</code> 属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;com.xyz.Pointcuts.publicMethod()&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">audit</span><span class="params">(JoinPoint jp)</span> &#123;</span><br><span class="line">    <span class="comment">// ... use jp</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>引用 “<a target="_blank" rel="noopener" href="https://springdoc.cn/spring/core.html#aop-pointcuts-combining">组合切点（Pointcut）表达式</a>” 中定义的 <code>publicMethod</code> 命名的pointcut。</p>
</blockquote>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="事务概述"><a href="#事务概述" class="headerlink" title="事务概述"></a>事务概述</h2><p>在一个业务流程当中，通常需要多条 <code>DML</code> 语句共同联合才能完成，这多条 <code>DML</code> 语句必须同时成功，或者同时失败，这样才能保证数据的安全。</p>
<p>事务的四个处理过程：</p>
<ol>
<li>开启事务 (<code>start transaction</code>)</li>
<li>执行核心业务代码</li>
<li>提交事务（如果核心业务处理过程中没有出现异常）(<code>commit transaction</code>)</li>
<li>回滚事务（如果核心业务处理过程中出现异常）(<code>rollback transaction</code>)</li>
</ol>
<h2 id="Spring对事务的支持"><a href="#Spring对事务的支持" class="headerlink" title="Spring对事务的支持"></a>Spring对事务的支持</h2><ul>
<li><p>编程式事务</p>
<ul>
<li>通过编写代码的方式来实现事务的管理。</li>
</ul>
</li>
<li><p>声明式事务</p>
<ul>
<li><p>基于注解方式</p>
</li>
<li><p>基于XML配置方式</p>
</li>
</ul>
</li>
</ul>
<p><code>Spring</code>  专门针对事务开发了一套 <code>API</code>，<code>API</code> 的核心接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span> <span class="keyword">extends</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    TransactionStatus <span class="title function_">getTransaction</span><span class="params">(TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PlatformTransactionManager</code> 接口：<code>spring</code>  事务管理器的核心接口。在**<code>Spring6</code>**中它有两个实现：</p>
<ul>
<li><code>DataSourceTransactionManager</code>：支持<code>JdbcTemplate</code>、<code>MyBatis</code>、<code>Hibernate</code>等事务管理。</li>
<li><code>JtaTransactionManager</code>：支持分布式事务管理。</li>
</ul>
<h2 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h2><p><code>Spring</code> 框架的声明式事务管理是通过 <code>Spring</code> 面向切面编程（<code>AOP</code>）实现的。然而，由于事务方面的代码是随 <code>Spring</code> 框架的发布而来，并且可以以模板的方式使用，所以一般不需要理解 <code>AOP</code> 的概念来有效地使用这些代码。</p>
<h3 id="注解实现"><a href="#注解实现" class="headerlink" title="注解实现"></a>注解实现</h3><p>使用注解 <code>@Transactional</code> 注解方法或者类，则可以为方法添加事务管理。</p>
<h4 id="xml配置"><a href="#xml配置" class="headerlink" title="xml配置"></a>xml配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--通过数据源配置DataSourceTransactionManager--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--对指定事务管理器开启声明式事务注解--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置类配置"><a href="#配置类配置" class="headerlink" title="配置类配置"></a>配置类配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">        basePackages = &#123;&quot;com.jhy.bank&quot;&#125;,</span></span><br><span class="line"><span class="meta">        excludeFilters = &#123;</span></span><br><span class="line"><span class="meta">            @ComponentScan.Filter(type = FilterType.ANNOTATION,classes = &#123;Data.class&#125;)</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;jdbc.properties&quot;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">//开启声明式事务</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.driver&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;jdbc.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//配置数据源</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DruidDataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        druidDataSource.setUrl(url);</span><br><span class="line">        druidDataSource.setDriverClassName(driver);</span><br><span class="line">        druidDataSource.setUsername(username);</span><br><span class="line">        druidDataSource.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> druidDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//通过数据源配置DataSourceTransactionManager</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">transactionManager</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="type">DataSourceTransactionManager</span> <span class="variable">dataSourceTransactionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">        dataSourceTransactionManager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>然后就可以使用注解 <code>@Transactional</code> 开启声明式事务</p>
</blockquote>
<h4 id="Transactional设置"><a href="#Transactional设置" class="headerlink" title="@Transactional设置"></a>@Transactional设置</h4><p>默认的 <code>@Transactional</code> 设置如下：</p>
<ul>
<li><code>propagation</code> （传播）设置为 <code>PROPAGATION_REQUIRED</code>。</li>
<li>隔离级别是 <code>ISOLATION_DEFAULT</code>。</li>
<li>事务是读写的。</li>
<li>事务超时默认为底层事务系统的默认超时，如果不支持超时，则默认为无。</li>
<li>任何 <code>RuntimeException</code> 或 <code>Error</code> 都会触发回滚，而任何被检查的 <code>Exception</code> 则不会。</li>
</ul>
<p>你可以改变这些默认设置。下表总结了 <code>@Transactional</code> 注解的各种属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th align="left">类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://springdoc.cn/spring/data-access.html#tx-multiple-tx-mgrs-with-attransactional">value</a></td>
<td align="left"><code>String</code></td>
<td align="left">可选的 <code>qualifier</code>，指定要使用的事务管理器。</td>
</tr>
<tr>
<td><code>transactionManager</code></td>
<td align="left"><code>String</code></td>
<td align="left"><code>value</code> 别名。</td>
</tr>
<tr>
<td><code>label</code></td>
<td align="left"><code>String</code> 标签数组，用于为事务添加表达式描述。</td>
<td align="left">标签可以由事务管理器评估，以便将特定于实现的行为与实际事务联系起来。</td>
</tr>
<tr>
<td>[propagation](# 事务传播（Propagation）)</td>
<td align="left"><code>enum</code>: <code>Propagation</code></td>
<td align="left">可选的 <code>propagation</code> （传播）设置。</td>
</tr>
<tr>
<td><a href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%EF%BC%88Isolation%EF%BC%89">isolation</a></td>
<td align="left"><code>enum</code>: <code>Isolation</code></td>
<td align="left">可选的隔离级别。仅适用于 <code>REQUIRED</code> 或 <code>REQUIRES_NEW</code> 的传播值。</td>
</tr>
<tr>
<td><a href="#%E4%BA%8B%E5%8A%A1%E8%B6%85%E6%97%B6%EF%BC%88timeout%EF%BC%89">timeout</a></td>
<td align="left"><code>int</code> (以秒为单位的粒度)</td>
<td align="left">可选的事务超时。仅适用于 <code>REQUIRED</code> 或 <code>REQUIRES_NEW</code> 的传播值。</td>
</tr>
<tr>
<td><code>timeoutString</code></td>
<td align="left"><code>String</code> (以秒为单位的粒度)</td>
<td align="left">用于指定以秒为单位的 <code>timeout</code>，作为 <code>String</code> 值的替代方案，例如，作为占位符。</td>
</tr>
<tr>
<td><a href="#%E5%8F%AA%E8%AF%BB%E4%BA%8B%E5%8A%A1%EF%BC%88readOnly%EF%BC%89">readOnly</a></td>
<td align="left"><code>boolean</code></td>
<td align="left">读写事务与只读事务。只适用于 <code>REQUIRED</code> 或 <code>REQUIRES_NEW</code> 的值。</td>
</tr>
<tr>
<td><a href="#%E5%BC%82%E5%B8%B8%E5%9B%9E%E6%BB%9A%EF%BC%88rollbackFor%EF%BC%89">rollbackFor</a></td>
<td align="left"><code>Class</code> 对象的数组，必须从 <code>Throwable</code> 派生。</td>
<td align="left">可选的必然会引起回滚的异常类型数组</td>
</tr>
<tr>
<td><code>rollbackForClassName</code></td>
<td align="left">异常名称模式（pattern）的数组。</td>
<td align="left">可选的必然会引起回滚异常名称模式（<code>patterns</code>）数组。</td>
</tr>
<tr>
<td><a href="#%E5%BC%82%E5%B8%B8%E4%B8%8D%E5%9B%9E%E6%BB%9A%EF%BC%88rollbackFor">noRollbackFor</a></td>
<td align="left">必须从 <code>Throwable</code> 派生的 <code>Class</code> 对象的数组。</td>
<td align="left">可选的不会引起回滚的 <code>exception</code> 类型数组</td>
</tr>
<tr>
<td><code>noRollbackForClassName</code></td>
<td align="left">异常名称模式（pattern）的数组。</td>
<td align="left">可选的不会引起回滚异常名称模式（<code>patterns</code>）数组。</td>
</tr>
</tbody></table>
<h5 id="事务传播（Propagation）"><a href="#事务传播（Propagation）" class="headerlink" title="事务传播（Propagation）"></a>事务传播（Propagation）</h5><p>一共有七种传播行为：</p>
<ul>
<li>REQUIRED：支持当前事务，如果不存在当前事务就新建一个(默认)<strong>【没有就新建，有就加入】</strong></li>
<li>SUPPORTS：支持当前事务，如果当前没有事务，就以非事务方式执行<strong>【有就加入，没有就不管了】</strong></li>
<li>MANDATORY：必须运行在一个事务中，如果当前没有事务，就会抛出一个异常<strong>【有就加入，没有就抛异常】</strong></li>
<li>REQUIRES_NEW：开启一个新的事务，如果一个事务已经存在，则将这个存在的事务挂起<strong>【不管有没有，直接开启一个新事务，开启的新事务和之前的事务不存在嵌套关系，之前事务被挂起】</strong></li>
<li>NOT_SUPPORTED：以非事务方式运行，如果当前有事务存在，则挂起当前事务<strong>【不支持事务，存在就挂起】</strong></li>
<li>NEVER：以非事务方式运行，如果有一个事务存在，抛出异常<strong>【不支持事务，存在就抛异常】</strong></li>
<li>NESTED：如果当前正有一个事务在进行中，则该方法应当运行在一个嵌套式事务中。被嵌套的事务可以独立于外层事务进行提交或回滚。如果外层事务不存在，行为就像REQUIRED一样。<strong>【有事务的话，就在这个事务里再嵌套一个完全独立的事务，嵌套的事务可以独立的提交和回滚。没有事务就和REQUIRED一样。】</strong></li>
</ul>
<h5 id="事务隔离级别（Isolation）"><a href="#事务隔离级别（Isolation）" class="headerlink" title="事务隔离级别（Isolation）"></a>事务隔离级别（Isolation）</h5><p>数据库中读取数据存在的三大问题：（三大读问题）</p>
<ul>
<li><strong>脏读：读取到没有提交到数据库的数据，叫做脏读。</strong><ul>
<li><code>a</code>先进来修改了数据但未提交，此时切换至<code>b</code>，<code>b</code>读取该数据，此后切换至<code>a</code>提交</li>
</ul>
</li>
<li><strong>不可重复读：在同一个事务当中，第一次和第二次读取的数据不一样。</strong><ul>
<li><code>a</code>先进来读取了数据，然后切换至<code>b</code>修改了数据并进行提交，此后切换至<code>a</code>重新读取了数据</li>
</ul>
</li>
<li><strong>幻读：读到的数据是假的。</strong><ul>
<li><code>a</code>先进来但未开始读取数据，然后切换至<code>b</code>修改了数据并提交，此后切换至<code>a</code>开始读取数据</li>
</ul>
</li>
</ul>
<p>事务隔离级别包括四个级别，分别解决上述问题：</p>
<ul>
<li><p>读未提交：<code>READ_UNCOMMITTED</code></p>
<ul>
<li>这种隔离级别，存在脏读问题，所谓的脏读(dirty read)表示能够读取到其它事务未提交的数据。</li>
</ul>
</li>
<li><p>读提交：<code>READ_COMMITTED</code></p>
<ul>
<li>解决了脏读问题，其它事务提交之后才能读到，但存在不可重复读问题。</li>
</ul>
</li>
<li><p>可重复读：<code>REPEATABLE_READ</code></p>
<ul>
<li>解决了不可重复读，可以达到可重复读效果，只要当前事务不结束，读取到的数据一直都是一样的。但存在幻读问题。</li>
</ul>
</li>
<li><p>序列化：<code>SERIALIZABLE</code></p>
<ul>
<li>解决了幻读问题，事务排队执行。不支持并发。</li>
</ul>
<table>
<thead>
<tr>
<th><strong>隔离级别</strong></th>
<th><strong>脏读</strong></th>
<th><strong>不可重复读</strong></th>
<th><strong>幻读</strong></th>
</tr>
</thead>
<tbody><tr>
<td>读未提交</td>
<td><strong>有</strong></td>
<td><strong>有</strong></td>
<td><strong>有</strong></td>
</tr>
<tr>
<td>读提交</td>
<td>无</td>
<td><strong>有</strong></td>
<td><strong>有</strong></td>
</tr>
<tr>
<td>可重复读</td>
<td>无</td>
<td>无</td>
<td><strong>有</strong></td>
</tr>
<tr>
<td>序列化</td>
<td>无</td>
<td>无</td>
<td>无</td>
</tr>
</tbody></table>
</li>
</ul>
<p>在 <code>Spring</code> 中事务隔离有 <strong>5</strong> 种情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Isolation</span> &#123;</span><br><span class="line">	<span class="comment">//默认，数据库未Mysql则为可重复读，Oracle则为读未提交</span></span><br><span class="line">	DEFAULT(TransactionDefinition.ISOLATION_DEFAULT),</span><br><span class="line">	<span class="comment">//读未提交</span></span><br><span class="line">	READ_UNCOMMITTED(TransactionDefinition.ISOLATION_READ_UNCOMMITTED),</span><br><span class="line">	<span class="comment">//读可提交</span></span><br><span class="line">	READ_COMMITTED(TransactionDefinition.ISOLATION_READ_COMMITTED),</span><br><span class="line">	<span class="comment">//可重复度</span></span><br><span class="line">	REPEATABLE_READ(TransactionDefinition.ISOLATION_REPEATABLE_READ),</span><br><span class="line">	<span class="comment">//序列化</span></span><br><span class="line">	SERIALIZABLE(TransactionDefinition.ISOLATION_SERIALIZABLE);</span><br></pre></td></tr></table></figure>

<h5 id="事务超时（timeout）"><a href="#事务超时（timeout）" class="headerlink" title="事务超时（timeout）"></a>事务超时（timeout）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(timeout = 10)</span></span><br></pre></td></tr></table></figure>

<p>以秒为单位，如果<strong>指定时间</strong>内 <code>DML</code> 语句还未执行完成 <strong>最终结果会选择回滚。</strong>，那么则会抛出错误。默认值-1，表示没有时间限制。</p>
<blockquote>
<p>指定时间：指的是从最后一条事务语句结束之前的时间，在这后的时间都不算</p>
</blockquote>
<h5 id="只读事务（readOnly）"><a href="#只读事务（readOnly）" class="headerlink" title="只读事务（readOnly）"></a>只读事务（readOnly）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(readOnly = true)</span></span><br></pre></td></tr></table></figure>

<p>将当前事务设置为只读事务，在该事务执行过程中只允许 <code>select</code> 语句执行，其余的 <code>DML</code> 语句均不会允许执行。</p>
<h5 id="异常回滚（rollbackFor）"><a href="#异常回滚（rollbackFor）" class="headerlink" title="异常回滚（rollbackFor）"></a>异常回滚（rollbackFor）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = RuntimeException.class)</span></span><br></pre></td></tr></table></figure>

<p>设置发生了哪些异常才会回滚</p>
<h5 id="异常不回滚（rollbackFor）"><a href="#异常不回滚（rollbackFor）" class="headerlink" title="异常不回滚（rollbackFor）"></a>异常不回滚（rollbackFor）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(noRollbackFor = NullPointerException.class)</span></span><br></pre></td></tr></table></figure>

<p>设置发生哪些异常不会回滚</p>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p><code>Spring</code> 提供了一套 <code>API</code> 对 <code>junit</code> 进行了整合</p>
<h2 id="Spring对JUnit4的支持"><a href="#Spring对JUnit4的支持" class="headerlink" title="Spring对JUnit4的支持"></a>Spring对JUnit4的支持</h2><p>首先需要以下的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring整合JUnit的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--junit4依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&quot;classpath:spring.xml&quot;)</span> <span class="comment">//@ContextConfiguration(classes = MyConfiguration.class) 配置类的形式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringJUnit4Test</span> &#123;</span><br><span class="line">    </span><br><span class="line">  	<span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> User user;    </span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFoo</span><span class="params">()</span>&#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"> .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring对JUnit5的支持"><a href="#Spring对JUnit5的支持" class="headerlink" title="Spring对JUnit5的支持"></a>Spring对JUnit5的支持</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring整合JUnit的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--junit5依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&quot;classpath:spring.xml&quot;)</span> <span class="comment">//@ContextConfiguration(classes = MyConfiguration.class) 配置类的形式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringJUnit4Test</span> &#123;</span><br><span class="line">    </span><br><span class="line">  	<span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFoo</span><span class="params">()</span>&#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"> .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>现在你不需要像以前那样获取 <code>IoC</code> 容器之后再获取 <code>bean</code> ，而是可以通过自动装配的方式来获取 <code>bean</code></p>
</blockquote>
<h1 id="整合Mybtias"><a href="#整合Mybtias" class="headerlink" title="整合Mybtias"></a>整合Mybtias</h1><p>将步骤分为 <strong>11</strong> 步：</p>
<ol>
<li>导入依赖</li>
<li>编写三层架构</li>
<li>创建 <code>pojo</code></li>
<li><a href="#%E7%BC%96%E5%86%99Mybatis%E7%9A%84%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">编写 Mybatis 的核心配置文件</a><ul>
<li>该文件可以没有，大部分的配置可以转移到 <code>Spring</code> 配置文件中。</li>
</ul>
</li>
<li>编写 <code>mapper</code> 映射文件</li>
<li>配置 <code>IoC</code> 容器中三层架构的 <code>bean</code> </li>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90">配置数据源</a></li>
<li><a href="#%E9%85%8D%E7%BD%AESqlSessionFactoryBean">配置SqlSessionFactoryBean</a><ul>
<li>用于生产 <code>SqlSessionFactory</code></li>
</ul>
</li>
<li><a href="#%E9%85%8D%E7%BD%AEmapper%E6%8E%A5%E5%8F%A3%E6%89%AB%E6%8F%8F%E5%99%A8">配置 mapper 接口扫描器</a><ul>
<li>用于将 <code>mapper</code> 接口的代理类注册为 <code>bean</code></li>
</ul>
</li>
<li><a href="#%E9%85%8D%E7%BD%AE%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8">配置事务管理器</a></li>
<li><a href="#%E5%BC%80%E5%90%AF%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1">开启声明式事务</a></li>
</ol>
<h2 id="编写Mybatis的核心配置文件"><a href="#编写Mybatis的核心配置文件" class="headerlink" title="编写Mybatis的核心配置文件"></a>编写Mybatis的核心配置文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mybatis的总配置文件--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">   	<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	关于Mybatis环境、数据源等移动至Spring配置文件</span></span><br><span class="line"><span class="comment">	核心设置必须在该配置文件中配置</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置SqlSessionFactoryBean"><a href="#配置SqlSessionFactoryBean" class="headerlink" title="配置SqlSessionFactoryBean"></a>配置SqlSessionFactoryBean</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span> <span class="comment">&lt;!--注入数据源--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;mybatis-config.xml&quot;</span>/&gt;</span> <span class="comment">&lt;!--配置文件所在位置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;typeAliasesPackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.jhy.acct.entity&quot;</span>/&gt;</span> <span class="comment">&lt;!--起别名--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果mapper映射文件和接口不在同一目录要设置该属性--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com/jhy/acct/mapper/*.xml&quot;</span>/&gt;</span> <span class="comment">&lt;!--mapper映射文件所在地--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置mapper接口扫描器"><a href="#配置mapper接口扫描器" class="headerlink" title="配置mapper接口扫描器"></a>配置mapper接口扫描器</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.jhy.acct.mapper&quot;</span>/&gt;</span> <span class="comment">&lt;!--mapper接口的包路径--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Spring</code> 会默认扫描指定包下的 <code>Mapper</code> 接口，并根据命名规则自动加载对应的 <code>Mapper</code> 映射文件</p>
</blockquote>
<h2 id="配置事务管理器"><a href="#配置事务管理器" class="headerlink" title="配置事务管理器"></a>配置事务管理器</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="开启声明式事务"><a href="#开启声明式事务" class="headerlink" title="开启声明式事务"></a>开启声明式事务</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--spring上下文，同时引入aop，bean，core，expression--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--druid数据源--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入mybatis官方提供的mybatis与spring整合的依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--引入spring-jdbc，包括事务管理器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入junit依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入spring-test--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入jakarta的注解，包括@Resource--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入mybatis本体依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://funkynoob.gitee.io">JiangHaiYang aka Funkynoob</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://funkynoob.gitee.io/2024/02/21/spring/">https://funkynoob.gitee.io/2024/02/21/spring/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://funkynoob.gitee.io" target="_blank">Funkynoob的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring</a></div><div class="post_share"><div class="social-share" data-image="/images/funkynoob_avatar.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/02/17/git/" title="Git学习"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Git学习</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/funkynoob_avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">JiangHaiYang aka Funkynoob</div><div class="author-info__description">来自四川985大学川清华</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Funkynoob"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Funkynoob" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:riverseea@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/images/qq.jpg" target="_blank" title="qq"><i class="fa-brands fa-qq"></i></a><a class="social-icon" href="/images/wx.png" target="_blank" title="wechat"><i class="fa-brands fa-weixin"></i></a><a class="social-icon" href="https://steamcommunity.com/profiles/76561198888059361" target="_blank" title="steam"><i class="fa-brands fa-steam"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎光临寒舍</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">引入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IoC"><span class="toc-number">2.</span> <span class="toc-text">IoC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AASpring%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.1.</span> <span class="toc-text">第一个Spring程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.1.</span> <span class="toc-text">获取配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96IoC%E5%AE%B9%E5%99%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">获取IoC容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96bean"><span class="toc-number">2.1.3.</span> <span class="toc-text">获取bean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E5%AF%B9IOC%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">Spring对IOC的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-number">2.2.1.</span> <span class="toc-text">依赖注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#set%E6%B3%A8%E5%85%A5"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">set注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">构造器注入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set%E6%B3%A8%E5%85%A5%E4%B8%93%E9%A2%98"><span class="toc-number">2.2.2.</span> <span class="toc-text">set注入专题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%A4%96%E9%83%A8Bean"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">注入外部Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%86%85%E9%83%A8bean"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">注入内部bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E7%AE%80%E5%8D%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">注入简单类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A7%E8%81%94%E5%B1%9E%E6%80%A7%E8%B5%8B%E5%80%BC"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">级联属性赋值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E6%95%B0%E7%BB%84"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">注入数组</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.5.1.</span> <span class="toc-text">简单类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.5.2.</span> <span class="toc-text">引用类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5list%E9%9B%86%E5%90%88"><span class="toc-number">2.2.2.6.</span> <span class="toc-text">注入list集合</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E7%AE%80%E5%8D%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.2.6.1.</span> <span class="toc-text">是简单类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">2.2.2.6.2.</span> <span class="toc-text">引用类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5map%E9%9B%86%E5%90%88"><span class="toc-number">2.2.2.7.</span> <span class="toc-text">注入map集合</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%B1%BB%E5%9E%8B-1"><span class="toc-number">2.2.2.7.1.</span> <span class="toc-text">简单类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B-2"><span class="toc-number">2.2.2.7.2.</span> <span class="toc-text">引用类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5set%E9%9B%86%E5%90%88"><span class="toc-number">2.2.2.8.</span> <span class="toc-text">注入set集合</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%B1%BB%E5%9E%8B-2"><span class="toc-number">2.2.2.8.1.</span> <span class="toc-text">简单类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B-3"><span class="toc-number">2.2.2.8.2.</span> <span class="toc-text">引用类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5Properties"><span class="toc-number">2.2.2.9.</span> <span class="toc-text">注入Properties</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E7%A9%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8Cnull%E5%80%BC"><span class="toc-number">2.2.2.10.</span> <span class="toc-text">注入空字符串和null值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#p%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E6%B3%A8%E5%85%A5"><span class="toc-number">2.2.3.</span> <span class="toc-text">p命名空间注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E6%B3%A8%E5%85%A5"><span class="toc-number">2.2.4.</span> <span class="toc-text">c命名空间注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#util%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">2.2.5.</span> <span class="toc-text">util命名空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Exml%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">2.2.6.</span> <span class="toc-text">基于xml的自动装配</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%90%8D%E7%A7%B0"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">根据名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.2.6.2.</span> <span class="toc-text">根据类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E5%A4%96%E9%83%A8%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.7.</span> <span class="toc-text">引入外部属性配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bean%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">2.3.</span> <span class="toc-text">bean的作用域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bean%E7%9A%84%E5%88%9B%E9%80%A0"><span class="toc-number">2.4.</span> <span class="toc-text">bean的创造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.4.1.</span> <span class="toc-text">通过构造方法实例化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.4.2.</span> <span class="toc-text">通过简单工厂模式实例化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87factory-bean%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.4.3.</span> <span class="toc-text">通过factory-bean实例化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87FactoryBean%E6%8E%A5%E5%8F%A3%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.4.4.</span> <span class="toc-text">通过FactoryBean接口实例化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanFactory%E5%92%8CFactoryBean%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">BeanFactory和FactoryBean的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#BeanFactory"><span class="toc-number">2.4.4.1.1.</span> <span class="toc-text">BeanFactory</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#FactoryBean"><span class="toc-number">2.4.4.1.2.</span> <span class="toc-text">FactoryBean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.4.5.</span> <span class="toc-text">bean的生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFBean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.4.5.1.</span> <span class="toc-text">什么是Bean的生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%9F%A5%E9%81%93Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.4.5.2.</span> <span class="toc-text">为什么要知道Bean的生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B9%8B5%E6%AD%A5"><span class="toc-number">2.4.5.3.</span> <span class="toc-text">Bean的生命周期之5步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B9%8B7%E6%AD%A5"><span class="toc-number">2.4.5.4.</span> <span class="toc-text">Bean的生命周期之7步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B9%8B10%E6%AD%A5"><span class="toc-number">2.4.5.5.</span> <span class="toc-text">Bean的生命周期之10步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.4.5.6.</span> <span class="toc-text">不同作用域的生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E8%87%AA%E5%B7%B1%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%8A%A0%E5%85%A5%E5%88%B0IoC%E5%AE%B9%E5%99%A8"><span class="toc-number">2.4.5.7.</span> <span class="toc-text">将自己实例化的对象加入到IoC容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bean%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96"><span class="toc-number">2.4.6.</span> <span class="toc-text">bean的循环依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#set%E6%B3%A8%E5%85%A5%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">2.4.6.1.</span> <span class="toc-text">set注入的情况</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E9%83%A8%E4%B8%BAsingleton"><span class="toc-number">2.4.6.1.1.</span> <span class="toc-text">全部为singleton</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E4%B8%BAsingleton"><span class="toc-number">2.4.6.1.2.</span> <span class="toc-text">单个为singleton</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E9%83%A8%E4%B8%BAprototype"><span class="toc-number">2.4.6.1.3.</span> <span class="toc-text">全部为prototype</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">2.4.6.2.</span> <span class="toc-text">构造器注入的情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E7%BA%A7%E4%BE%9D%E8%B5%96%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96-%E6%BA%90%E7%A0%81"><span class="toc-number">2.4.6.3.</span> <span class="toc-text">三级依赖解决循环依赖(源码)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84Ioc%E5%BC%80%E5%8F%91"><span class="toc-number">2.5.</span> <span class="toc-text">基于注解的Ioc开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">2.5.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.5.2.</span> <span class="toc-text">注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">使用注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">自动装配</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Value"><span class="toc-number">2.5.2.2.1.</span> <span class="toc-text">@Value</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Autowired%E5%92%8C-Qualifier"><span class="toc-number">2.5.2.2.2.</span> <span class="toc-text">@Autowired和@Qualifier</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Primary"><span class="toc-number">2.5.2.2.3.</span> <span class="toc-text">@Primary</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Resource"><span class="toc-number">2.5.2.2.4.</span> <span class="toc-text">@Resource</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%B3%A8%E8%A7%A3%E5%BC%8F%E5%BC%80%E5%8F%91"><span class="toc-number">2.5.3.</span> <span class="toc-text">全注解式开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EJava%E7%9A%84%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.4.</span> <span class="toc-text">基于Java的容器配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Bean%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">使用@Bean注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA-Bean"><span class="toc-number">2.5.4.1.1.</span> <span class="toc-text">声明一个 Bean</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Bean-%E4%BE%9D%E8%B5%96"><span class="toc-number">2.5.4.1.2.</span> <span class="toc-text">Bean 依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E5%9B%9E%E8%B0%83"><span class="toc-number">2.5.4.1.3.</span> <span class="toc-text">接收生命周期的回调</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A-Bean-%E7%9A%84-Scope"><span class="toc-number">2.5.4.1.4.</span> <span class="toc-text">指定 Bean 的 Scope</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Scope-%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.5.4.1.4.1.</span> <span class="toc-text">使用 @Scope 注解</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Bean%E7%9A%84%E5%91%BD%E5%90%8D"><span class="toc-number">2.5.4.1.5.</span> <span class="toc-text">自定义Bean的命名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Bean-%E5%88%AB%E5%90%8D"><span class="toc-number">2.5.4.1.6.</span> <span class="toc-text">Bean 别名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Bean-%E6%8F%8F%E8%BF%B0%EF%BC%88Description%EF%BC%89"><span class="toc-number">2.5.4.1.7.</span> <span class="toc-text">Bean 描述（Description）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Configuration%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.5.4.2.</span> <span class="toc-text">使用@Configuration注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5bean%E9%97%B4%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="toc-number">2.5.4.2.1.</span> <span class="toc-text">注入bean间的依赖</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ComponentScan"><span class="toc-number">2.5.4.3.</span> <span class="toc-text">使用@ComponentScan</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">静态代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AOP"><span class="toc-number">4.</span> <span class="toc-text">AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.1.</span> <span class="toc-text">AOP介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP%E5%85%AB%E5%A4%A7%E6%9C%AF%E8%AF%AD"><span class="toc-number">4.2.</span> <span class="toc-text">AOP八大术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Spring%E7%9A%84AOP"><span class="toc-number">4.3.</span> <span class="toc-text">使用Spring的AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3-1"><span class="toc-number">4.3.1.</span> <span class="toc-text">注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-AspectJ%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">开启@AspectJ的支持</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-XML-%E5%BC%80%E5%90%AF"><span class="toc-number">4.3.1.1.1.</span> <span class="toc-text">通过 XML 开启</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B3%A8%E8%A7%A3%E5%BC%80%E5%90%AF"><span class="toc-number">4.3.1.1.2.</span> <span class="toc-text">通过注解开启</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA-Aspect%E7%B1%BB"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">声明一个 Aspect类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA%E5%88%87%E7%82%B9%EF%BC%88Pointcut%EF%BC%89"><span class="toc-number">4.3.1.3.</span> <span class="toc-text">声明一个切点（Pointcut）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E7%9A%84-Pointcut-%E6%8C%87%E5%AE%9A%E5%99%A8"><span class="toc-number">4.3.1.3.1.</span> <span class="toc-text">支持的 Pointcut 指定器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%87%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">4.3.1.3.1.1.</span> <span class="toc-text">切点表达式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E5%88%87%E7%82%B9%EF%BC%88Pointcut%EF%BC%89%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">4.3.1.3.1.2.</span> <span class="toc-text">组合切点（Pointcut）表达式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E-Advice"><span class="toc-number">4.3.1.4.</span> <span class="toc-text">声明 Advice</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Before-Advice"><span class="toc-number">4.3.1.4.1.</span> <span class="toc-text">Before Advice</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#After-Returning-Advice"><span class="toc-number">4.3.1.4.2.</span> <span class="toc-text">After Returning Advice</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#After-Throwing-Advice"><span class="toc-number">4.3.1.4.3.</span> <span class="toc-text">After Throwing Advice</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#After-Finally-Advice"><span class="toc-number">4.3.1.4.4.</span> <span class="toc-text">After (Finally) Advice</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Around-Advice"><span class="toc-number">4.3.1.4.5.</span> <span class="toc-text">Around Advice</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Advice-%E5%8F%82%E6%95%B0"><span class="toc-number">4.3.1.4.6.</span> <span class="toc-text">Advice 参数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%BD%93%E5%89%8D%E7%9A%84-JoinPoint"><span class="toc-number">4.3.1.4.6.1.</span> <span class="toc-text">访问当前的 JoinPoint</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%90%91-Advice-%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0"><span class="toc-number">4.3.1.4.6.2.</span> <span class="toc-text">向 Advice 传递参数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Advice-%E5%8F%82%E6%95%B0%E5%92%8C%E6%B3%9B%E5%9E%8B"><span class="toc-number">4.3.1.4.6.3.</span> <span class="toc-text">Advice 参数和泛型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%8F%82%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="toc-number">4.3.1.4.6.4.</span> <span class="toc-text">确定参数名称</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%98%8E%E7%A1%AE%E7%9A%84%E5%8F%82%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="toc-number">4.3.1.4.6.5.</span> <span class="toc-text">明确的参数名称</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">事务概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E5%AF%B9%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">5.2.</span> <span class="toc-text">Spring对事务的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.3.</span> <span class="toc-text">声明式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.1.</span> <span class="toc-text">注解实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#xml%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.1.1.</span> <span class="toc-text">xml配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.1.2.</span> <span class="toc-text">配置类配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transactional%E8%AE%BE%E7%BD%AE"><span class="toc-number">5.3.1.3.</span> <span class="toc-text">@Transactional设置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%EF%BC%88Propagation%EF%BC%89"><span class="toc-number">5.3.1.3.1.</span> <span class="toc-text">事务传播（Propagation）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%EF%BC%88Isolation%EF%BC%89"><span class="toc-number">5.3.1.3.2.</span> <span class="toc-text">事务隔离级别（Isolation）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E8%B6%85%E6%97%B6%EF%BC%88timeout%EF%BC%89"><span class="toc-number">5.3.1.3.3.</span> <span class="toc-text">事务超时（timeout）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AA%E8%AF%BB%E4%BA%8B%E5%8A%A1%EF%BC%88readOnly%EF%BC%89"><span class="toc-number">5.3.1.3.4.</span> <span class="toc-text">只读事务（readOnly）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%9B%9E%E6%BB%9A%EF%BC%88rollbackFor%EF%BC%89"><span class="toc-number">5.3.1.3.5.</span> <span class="toc-text">异常回滚（rollbackFor）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E4%B8%8D%E5%9B%9E%E6%BB%9A%EF%BC%88rollbackFor%EF%BC%89"><span class="toc-number">5.3.1.3.6.</span> <span class="toc-text">异常不回滚（rollbackFor）</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">6.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E5%AF%B9JUnit4%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">6.1.</span> <span class="toc-text">Spring对JUnit4的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E5%AF%B9JUnit5%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">6.2.</span> <span class="toc-text">Spring对JUnit5的支持</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B4%E5%90%88Mybtias"><span class="toc-number">7.</span> <span class="toc-text">整合Mybtias</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99Mybatis%E7%9A%84%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.</span> <span class="toc-text">编写Mybatis的核心配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">7.2.</span> <span class="toc-text">配置数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AESqlSessionFactoryBean"><span class="toc-number">7.3.</span> <span class="toc-text">配置SqlSessionFactoryBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEmapper%E6%8E%A5%E5%8F%A3%E6%89%AB%E6%8F%8F%E5%99%A8"><span class="toc-number">7.4.</span> <span class="toc-text">配置mapper接口扫描器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">7.5.</span> <span class="toc-text">配置事务管理器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">7.6.</span> <span class="toc-text">开启声明式事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96"><span class="toc-number">7.7.</span> <span class="toc-text">依赖</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/21/spring/" title="Spring">Spring</a><time datetime="2024-02-21T05:47:16.000Z" title="发表于 2024-02-21 13:47:16">2024-02-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/17/git/" title="Git学习">Git学习</a><time datetime="2024-02-17T12:42:54.000Z" title="发表于 2024-02-17 20:42:54">2024-02-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/28/mybatis/" title="MyBatis">MyBatis</a><time datetime="2024-01-28T07:12:54.000Z" title="发表于 2024-01-28 15:12:54">2024-01-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/01/23/nginx/" title="Nginx">Nginx</a><time datetime="2024-01-23T14:08:01.000Z" title="发表于 2024-01-23 22:08:01">2024-01-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/04/music-gallery/" title="音乐及画廊配置以及一些小配置">音乐及画廊配置以及一些小配置</a><time datetime="2023-12-04T15:16:52.000Z" title="发表于 2023-12-04 23:16:52">2023-12-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By JiangHaiYang aka Funkynoob</div><div class="footer_custom_text">爱来自瓷器❤</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const abcjsInit = () => {
    const abcjsFn = () => {
      document.querySelectorAll(".abc-music-sheet").forEach(ele => {
        ABCJS.renderAbc(ele, ele.innerHTML, {responsive: 'resize'})
      })
    }
    
    typeof ABCJS === 'object' ? abcjsFn()
      : getScript('https://cdn.jsdelivr.net/npm/abcjs/dist/abcjs-basic-min.min.js').then(abcjsFn)
  }

  window.pjax ? abcjsInit() : window.addEventListener('load', abcjsInit)
})()</script></div><div class="aplayer no-destroy" data-id="476341452" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>